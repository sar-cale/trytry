<!DOCTYPE html>
<html lang="zh-CN">

<body>
<body>
    <div id="phone-screen">
      <div id="status-bar">
        <span id="status-bar-time">12:00</span>
        <div id="status-bar-battery" class="battery-container">
          <span class="battery-text">--%</span>
          <div class="battery-icon">
            <div class="battery-level"></div>
          </div>
        </div>
      </div>
      <div id="notification-bar">
        <img id="notification-avatar" src="" />
        <div id="notification-content">
          <div class="name"></div>
          <div class="message"></div>
        </div>
      </div>

      <div id="video-call-floating-bubble" style="display: none">
        <img id="video-floating-avatar" src="" />
      </div>

      <div id="floating-lyrics-bar">
        <span id="floating-lyric-text">♪</span>

        <div
          id="lyrics-settings-btn"
          style="cursor: pointer; display: flex; align-items: center; justify-content: center"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="3"></circle>
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
            ></path>
          </svg>
        </div>
        <span class="close-btn">×</span>
      </div>

      <div id="lock-screen-background-blur" style="display: none"></div>

      <div id="home-screen" class="screen active">
        <div class="home-screen-slider">
          <!-- 第一页，把原来的内容都放进来 -->
          <div class="home-page">
            <div id="main-content-area">
              <div id="profile-widget">
                <img
                  id="profile-banner-img"
                  src="https://i.postimg.cc/k495F4W5/profile-banner.jpg"
                  class="editable-image"
                />

                <div class="profile-avatar-container">
                  <img
                    id="profile-avatar-img"
                    src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg"
                    class="editable-image"
                  />

                  <img id="profile-avatar-frame" class="weibo-avatar-frame" src="" style="display: none" />
                </div>

                <div class="profile-info">
                  <p id="profile-username" class="editable-text">你的昵称</p>
                  <p id="profile-sub-username" class="editable-text">@your_id</p>
                  <p id="profile-bio" class="editable-text">点击这里编辑你的个性签名</p>
                  <p id="profile-location" class="editable-text" data-placeholder="点击编辑地点">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                      <path
                        d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"
                      ></path>
                    </svg>
                    <span>点击编辑地点</span>
                  </p>
                </div>
              </div>
              <div id="desktop-layout">
                <div id="desktop-widget-column">
                  <div class="custom-widget-container">
                    <div id="widget-bubble-1" class="widget-bubble editable-text" contenteditable="true">
                      点击编辑文字
                    </div>
                    <div class="widget-circle-uploader">
                      <img
                        id="widget-image-1"
                        src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg"
                        class="editable-image"
                        title="点击更换图片"
                      />
                    </div>
                    <div id="widget-subtext-1" class="widget-subtext editable-text" contenteditable="true">
                      点击编辑文字
                    </div>
                  </div>
                  <div class="custom-widget-container">
                    <div id="widget-bubble-2" class="widget-bubble editable-text" contenteditable="true">
                      点击编辑文字
                    </div>
                    <div class="widget-circle-uploader">
                      <img
                        id="widget-image-2"
                        src="https://i.postimg.cc/k495F4W5/profile-banner.jpg"
                        class="editable-image"
                        title="点击更换图片"
                      />
                    </div>
                    <div id="widget-subtext-2" class="widget-subtext editable-text" contenteditable="true">
                      点击编辑文字
                    </div>
                  </div>
                </div>
                <div id="desktop-app-container">
                  <div class="desktop-app-icon" onclick="showScreen('chat-list-screen')">
                    <div class="icon-bg-desktop">
                      <img id="icon-img-qq" src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg" alt="QQ" />
                    </div>
                    <span class="label">QQ</span>
                  </div>
                  <div class="desktop-app-icon" onclick="showScreen('world-book-screen')">
                    <div class="icon-bg-desktop">
                      <img id="icon-img-world-book" src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg" alt="世界书" />
                    </div>
                    <span class="label">世界书</span>
                  </div>
                  <div id="check-phone-btn" class="desktop-app-icon">
                    <div class="icon-bg-desktop">
                      <img id="icon-img-check-phone" src="https://i.postimg.cc/RVwpwr0r/IMG-8348.jpg" alt="查手机" />
                    </div>
                    <span class="label">查手机</span>
                  </div>
                  <div class="desktop-app-icon" id="kk-checkin-app-icon">
                    <div class="icon-bg-desktop">
                      <img id="icon-img-weibo" src="https://i.postimg.cc/MGwrL0nf/kitty.png" alt="kk查岗" />
                    </div>
                    <span class="label">kk查岗</span>
                  </div>
                </div>
              </div>
            </div>
          </div>



应该是【底部dock栏】
        <!-- 底部 Dock 栏保持不变 -->
        <div id="desktop-dock">
          <div class="desktop-app-icon" onclick="showScreen('api-settings-screen')">
            <div class="icon-bg-desktop">
              <img id="icon-img-api-settings" src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg" alt="API设置" />
            </div>
            <span class="label">API设置</span>
          </div>

          <div class="desktop-app-icon" id="studio-app-icon">
            <div class="icon-bg-desktop">
              <!-- 这里的 id="icon-img-studio" 必须保留，用于JS识别更换图标 -->
              <img id="icon-img-studio" src="https://i.postimg.cc/W3sLz11s/clapperboard-icon.png" alt="小剧场" />
            </div>
            <!-- lrq小剧场 -->
            <span class="label">lrq小剧场</span>
          </div>

          <div class="desktop-app-icon" onclick="showScreen('font-settings-screen')">
            <div class="icon-bg-desktop">
              <img id="icon-img-font" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="字体" />
            </div>
            <span class="label">字体</span>
          </div>
          <div class="desktop-app-icon" onclick="showScreen('wallpaper-screen')">
            <div class="icon-bg-desktop">
              <img id="icon-img-wallpaper" src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg" alt="外观设置" />
            </div>
            <span class="label">外观设置</span>
          </div>
        </div>


看起来像【世界书功能】
      <div id="world-book-screen" class="screen">
        <div class="header">
          <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
          <span>世界书</span>
          <div class="header-actions">
            <span class="action-btn" id="import-world-book-btn" title="导入世界书">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </span>

            <span class="action-btn" id="manage-categories-in-edit-mode-btn" style="display: none" title="管理分类">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
            </span>

            <span
              class="action-btn btn-danger"
              id="world-book-delete-selected-btn"
              style="display: none"
              title="删除已选"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
              <span id="world-book-delete-count" style="font-size: 12px; margin-left: 2px"></span>
              <!-- 用于显示数量 -->
            </span>

            <span class="action-btn" id="toggle-world-book-edit-mode-btn">编辑模式</span>

            <span class="action-btn" id="add-world-book-btn">+</span>
          </div>
        </div>
        <div id="world-book-list"></div>
      </div>

      <div id="world-book-editor-screen" class="screen">
        <div class="header">
          <span class="back-btn" onclick="showScreen('world-book-screen')">‹</span>
          <span id="world-book-editor-title">编辑世界书</span>
          <span class="save-btn" id="save-world-book-btn">保存</span>
        </div>
        <div class="form-container">
          <div class="form-group">
            <label for="world-book-name-input">书名</label>
            <input type="text" id="world-book-name-input" placeholder="请输入世界书的名称..." />
          </div>

          <div class="form-group">
            <label for="world-book-category-select">分类</label>
            <select id="world-book-category-select">
              <!-- 选项将由JS动态生成 -->
            </select>
          </div>

          <div class="form-group" style="height: 100%">
            <label for="world-book-content-input">内容</label>
            <textarea id="world-book-content-input" placeholder="在此处输入详细的世界观设定..."></textarea>
          </div>
        </div>
      </div>


看起来像【api功能】
ps：“高级导入/导出”下面那一段我不知道是什么
      <div id="api-settings-screen" class="screen moe-theme">
        <div class="header">
          <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
          <span> API设置 </span>
          <span style="width: 30px"></span>
        </div>

        <!-- 内容滚动区域 -->
        <div class="form-container">
          <!-- 1. 云端大脑卡片 -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">☁️</span>
              <h3>API 连接</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label>反代地址 (Proxy)</label>
                <input type="text" id="proxy-url" placeholder="https://api.openai.com" class="moe-input" />
              </div>
              <div class="form-group">
                <label>密钥 (Key)</label>
                <input type="password" id="api-key" placeholder="sk-..." class="moe-input" />
              </div>
              <div class="form-group">
                <label>模型选择</label>
                <select id="model-select" class="moe-input"></select>
              </div>
              <div class="form-group">
                <label>预设配置</label>
                <div class="bubble-preset-manager">
                  <select id="api-preset-select" class="moe-input"></select>
                  <button id="manage-api-presets-btn" class="moe-btn-small">管理</button>
                </div>
              </div>
              <div class="form-group">
                <label>温度 (随机性): <span id="temperature-value" style="color: var(--accent-color)">0.8</span></label>
                <input type="range" id="temperature-slider" min="0" max="2" step="0.1" value="0.8" class="moe-slider" />
              </div>
              <button id="fetch-models-btn" class="moe-btn-secondary">📡 拉取模型列表</button>
            </div>
          </div>

          <!-- 3. 后台活动卡片 -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">🤖</span>
              <h3>角色后台活动</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label class="toggle-switch-label">
                  <span class="toggle-switch-text">启用后台活动</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="background-activity-switch" />
                    <span class="slider"></span>
                  </label>
                </label>
              </div>
              <div id="background-activity-details" style="display: none; margin-top: 10px">
                <div class="form-group">
                  <label>检测间隔 (秒)</label>
                  <input
                    type="number"
                    id="background-interval-input"
                    min="30"
                    value="60"
                    class="moe-input center-text"
                  />
                </div>
                <div class="form-group">
                  <label>角色频率设置</label>
                  <div id="background-activity-char-list" class="moe-list-box"></div>
                  <div class="moe-btn-group">
                    <button id="bg-select-all-chars" class="moe-btn-mini">全选</button>
                    <button id="bg-deselect-all-chars" class="moe-btn-mini">全不选</button>
                  </div>
                </div>
                <div class="form-group">
                  <label>设置频率</label>
                  <div class="moe-btn-group">
                    <button class="moe-btn-mini bg-freq-btn" data-freq="low">低</button>
                    <button class="moe-btn-mini bg-freq-btn" data-freq="medium">中</button>
                    <button class="moe-btn-mini bg-freq-btn" data-freq="high">高</button>
                    <button class="moe-btn-mini bg-freq-btn" data-freq="none">关闭</button>
                  </div>
                </div>
              </div>
              <div class="moe-divider"></div>
              <div class="form-group">
                <label>拉黑冷静期 (小时)</label>
                <input
                  type="number"
                  id="block-cooldown-input"
                  min="0.1"
                  step="0.1"
                  value="1"
                  class="moe-input center-text"
                />
              </div>
            </div>
          </div>

          <!-- 5. 存储与备份卡片 -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">💾</span>
              <h3>存储与备份</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label>图片压缩质量: <span id="image-quality-value">0.7</span></label>
                <input
                  type="range"
                  id="image-quality-slider"
                  min="0.1"
                  max="1.0"
                  step="0.1"
                  value="0.7"
                  class="moe-slider"
                />
              </div>
              <button class="moe-btn-secondary" id="compress-all-images-btn">📉 一键压缩图片</button>
              <p id="image-data-size-display" style="text-align: center; font-size: 12px; color: #aaa; margin-top: 5px">
                ...
              </p>

              <div class="moe-divider"></div>

              <h4 style="font-size: 14px; margin-bottom: 10px; color: var(--accent-color)">☁️ GitHub 云备份</h4>
              <div class="form-group">
                <input
                  type="password"
                  id="github-token"
                  placeholder="Token"
                  class="moe-input"
                  style="margin-bottom: 5px"
                />
                <input
                  type="text"
                  id="github-username"
                  placeholder="用户名"
                  class="moe-input"
                  style="margin-bottom: 5px"
                />
                <input type="text" id="github-repo" placeholder="仓库名" class="moe-input" style="margin-bottom: 5px" />
                <input type="text" id="github-path" placeholder="路径 (可选)" class="moe-input" />
              </div>
              <div class="form-group">
                <label class="toggle-switch-label">
                  <span class="toggle-switch-text">自动备份 </span>
                  <input type="checkbox" id="github-auto-backup-switch" />
                  <span class="toggle-switch-slider"></span>
                </label>
              </div>
              <!-- 在 github-path 输入框下方插入 -->
              <div class="form-group" style="margin-top: 5px">
                <label>自动备份模式</label>
                <div style="display: flex; gap: 10px">
                  <select id="github-backup-mode" class="moe-input" style="flex: 1">
                    <option value="full">全量</option>
                    <option value="stream">流式 (分片/稳定)</option>
                  </select>
                  <input
                    type="number"
                    id="github-backup-interval"
                    class="moe-input"
                    style="width: 80px"
                    placeholder="分钟"
                    value="30"
                    min="5"
                  />
                  <span style="align-self: center; font-size: 12px; color: #888">分钟</span>
                </div>
              </div>

              <div class="moe-btn-group">
                <button id="manual-github-backup-btn" class="moe-btn-secondary">☁️ 上传 (全量)</button>
                <button id="manual-github-restore-btn" class="moe-btn-secondary">📥 恢复 (全量)</button>
              </div>
              <div class="moe-btn-group" style="margin-top: 10px">
                <button
                  id="git-stream-upload-btn"
                  class="moe-btn-secondary"
                  style="background-color: #6f42c1; color: white"
                >
                  🌊 Git流式上传
                </button>
                <button
                  id="git-stream-restore-btn"
                  class="moe-btn-secondary"
                  style="background-color: #6f42c1; color: white"
                >
                  🎣 Git流式导入
                </button>
              </div>
              <p style="font-size: 12px; color: #999; margin-top: 5px">
                * 流式模式会将数据拆分为多个文件(按表)上传，解决大文件导致崩溃的问题。
              </p>

              <div class="moe-divider"></div>

              <h4 style="font-size: 14px; margin-bottom: 10px; color: var(--accent-color)">📦 本地备份</h4>
              <div class="moe-btn-group">
                <button class="moe-btn-secondary" id="export-data-btn">导出</button>
                <button class="moe-btn-secondary" id="import-btn">导入</button>
                <button class="moe-btn-secondary" id="export-data-stream-btn">流式导出</button>
              </div>
              <button class="moe-btn-secondary" id="advanced-transfer-btn" style="margin-top: 8px; width: 100%">
                高级导入/导出
              </button>

              <div class="moe-divider"></div>
              <button class="moe-btn-danger" id="clear-orphaned-data-btn">🧹 清理失效数据</button>
            </div>
          </div>

          <div style="text-align: center; margin-bottom: 15px; margin-top: 5px">
            <a
              href="https://jcny642xl7ll.feishu.cn/wiki/KGsnwECKji2xdxkCqDbcZNOnndd"
              target="_blank"
              style="
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 10px 20px;
                background-color: rgba(255, 255, 255, 0.9);
                color: var(--accent-color, #007bff);
                text-decoration: none;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                border: 1px solid rgba(0, 0, 0, 0.05);
                transition: transform 0.2s;
              "
            >
              <span>📖</span> 兔k写的一些教程
            </a>
          </div>

          <!-- 底部留白，防止被悬浮按钮遮挡 -->
          <div style="height: 80px"></div>
        </div>

        <!-- ★★★ 萌系悬浮保存按钮 ★★★ -->
        <button id="save-api-settings-btn" class="moe-fab-save">
          💾<span style="font-size: 12px; display: block; margin-top: -2px">保存</span>
        </button>

        <!-- 隐藏的 input -->
        <input id="import-data-input" type="file" accept="application/json" hidden />
      </div>



如果没有猜错【QQ功能】
      <div id="chat-list-screen" class="screen">
        <!-- 主头部 (只在消息列表显示) -->
        <div class="header" id="main-chat-list-header">
          <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
          <span id="chat-list-title">消息</span>
          <div class="header-actions">
            <span class="action-btn" id="add-group-chat-btn" title="创建群聊">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M21 21L19 19"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>

            <span class="action-btn" id="import-character-card-btn" title="导入角色卡">
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </span>

            <span class="action-btn" id="add-chat-btn">+</span>
          </div>
        </div>

        <!-- 消息列表视图 -->
        <div id="messages-view" class="chat-list-view active">
          <div id="chat-list">
            <!-- JS会在这里生成聊天列表 -->
          </div>
        </div>

        <!-- 动态界面视图 -->
        <div id="qzone-screen" class="chat-list-view">
          <div class="qzone-header">
            <span class="back-btn" id="qzone-back-btn">‹</span>
            <!-- 这个按钮现在只负责从动态返回 -->
            <span>好友动态</span>

            <div class="header-actions">
              <span class="action-btn" id="clear-qzone-posts-btn" title="清空动态">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                </svg>
              </span>
            </div>
          </div>
          <div class="qzone-content">
            <div class="qzone-profile-header">
              <div id="qzone-banner-container" class="qzone-banner-container">
                <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="背景" />
                <input type="file" id="qzone-banner-input" accept="image/*" hidden />
              </div>
              <div class="qzone-user-info">
                <div id="qzone-avatar-container" class="qzone-avatar-container">
                  <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="头像" />
                  <input type="file" id="qzone-avatar-input" accept="image/*" hidden />
                </div>
                <span id="qzone-nickname">{{user}}</span>
              </div>
            </div>
            <div class="qzone-actions-bar">
              <div class="action-item" id="create-shuoshuo-btn"><span>说说</span></div>
              <div class="action-item" id="create-post-btn"><span>动态</span></div>
              <div class="action-item" id="open-album-btn"><span>相册</span></div>
            </div>
            <div id="qzone-posts-list"></div>
          </div>
        </div>

        <!-- 收藏界面视图 -->
        <div id="favorites-view" class="chat-list-view">
          <div class="header">
            <span class="back-btn" id="favorites-back-btn">‹</span>
            <span>我的收藏</span>
            <!-- 新增的编辑按钮 -->
            <span class="action-btn" id="favorites-edit-btn">编辑</span>
          </div>

          <!-- 搜索栏容器 -->
          <div class="search-bar-container">
            <input type="search" id="favorites-search-input" placeholder="搜索收藏的标题、内容或作者..." />
            <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none">×</button>
          </div>

          <div id="favorites-list" class="list-container">
            <!-- 收藏内容将由JS动态生成在这里 -->
          </div>

          <!-- 新增：收藏页底部操作栏 -->
          <div id="favorites-action-bar" style="display: none">
            <button id="favorites-delete-selected-btn" class="action-bar-btn">删除 (0)</button>
          </div>
        </div>

        <div id="memories-view" class="chat-list-view">
          <div class="header">
            <span class="back-btn" id="memories-back-btn">‹</span>
            <span>我们的回忆</span>
            <span class="action-btn" id="add-countdown-btn">+</span>
          </div>
          <div
            id="memories-list"
            class="list-container"
            style="padding: 15px; display: flex; flex-direction: column; gap: 15px"
          >
            <!-- 回忆卡片将由JS动态生成在这里 -->
          </div>
        </div>

        <!-- 底部导航栏 -->
        <div id="chat-list-bottom-nav">
          <div class="nav-item active" data-view="messages-view">
            <span>消息</span>
          </div>
          <div class="nav-item" data-view="qzone-screen">
            <span>动态</span>
          </div>

          <div class="nav-item" data-view="memories-view">
            <span>回忆</span>
          </div>

          <div class="nav-item" data-view="favorites-view">
            <span>收藏</span>
          </div>
        </div>
      </div>

      <div id="album-screen" class="screen">
        <!-- 1. 页面头部，包含返回按钮和标题 -->
        <div class="header">
          <span class="back-btn" id="album-back-btn">‹</span>
          <span>我的相册</span>
          <span class="action-btn" id="create-album-btn-page">+</span>
        </div>

        <!-- 2. 页面内容容器 -->
        <div class="list-container">
          <div id="album-grid-page">
            <!-- 相册列表将由 JS 动态生成在这里 -->
          </div>
        </div>
      </div>

      <div id="album-photos-screen" class="screen">
        <!-- 1. 页面头部 -->
        <div class="header">
          <span class="back-btn" id="album-photos-back-btn">‹</span>
          <span id="album-photos-title">相册名称</span>
          <span class="action-btn" id="album-upload-photo-btn">上传</span>
        </div>

        <!-- 2. 页面内容容器 -->
        <div class="list-container">
          <div id="photos-grid-page">
            <!-- 照片列表将由 JS 动态生成在这里 -->
          </div>

          <div id="photo-viewer-modal" class="modal">
            <!-- 1. 关闭按钮 -->
            <button id="photo-viewer-close-btn">×</button>

            <!-- 2. 上一张照片按钮 -->
            <button id="photo-viewer-prev-btn" class="nav-arrow">‹</button>

            <!-- 3. 图片容器 -->
            <div class="photo-viewer-content">
              <img id="photo-viewer-image" src="" alt="全屏照片预览" />
            </div>

            <!-- 4. 下一张照片按钮 -->
            <button id="photo-viewer-next-btn" class="nav-arrow">›</button>
          </div>
        </div>
      </div>

      <input type="file" id="album-photo-input" accept="image/*" multiple hidden />

      <div id="chat-interface-screen" class="screen">
        <div class="header">
          <!-- 默认控件：包含标题、状态栏和常规按钮 -->
          <div class="default-controls">
            <span class="back-btn" id="back-to-list-btn">‹</span>

            <!-- 标题和状态的容器 -->
            <div id="chat-header-title-wrapper">
              <div id="chat-header-main-line">
                <span id="chat-header-title">聊天对象</span>
                <!-- 【全新】群公告按钮 -->
                <span id="group-announcement-btn" title="群公告">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="7" y1="15" x2="17" y2="15"></line>
                  </svg>
                </span>
              </div>
              <div id="chat-header-status">
                <span class="status-dot"></span>
                <span class="status-text">在线</span>
              </div>
            </div>

            <div class="header-actions">
              <!-- 心声按钮 -->
              <span class="action-btn" id="char-heart-btn" title="心声" style="display: none; cursor: pointer">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="#ff4d6d"
                  stroke="#ffc3d0"
                  stroke-width="1.5"
                >
                  <path
                    d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
                  />
                </svg>
              </span>
              <span class="action-btn" id="listen-together-btn" title="一起听"
                ><img src="https://i.postimg.cc/CxjpF6gK/yi-qi-ting.png" alt="一起听"
              /></span>
              <span class="action-btn" id="chat-settings-btn" title="聊天设置"
                ><img src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png" alt="设置"
              /></span>
            </div>
          </div>

          <!-- 多选模式控件 -->
          <div class="selection-controls">
            <span id="selection-cancel-btn">取消</span>
            <span id="selection-count"></span>
            <div class="header-actions">
              <span id="selection-favorite-btn" class="action-btn">收藏</span>
              <span id="selection-share-btn" class="action-btn">分享</span>
              <span id="selection-delete-btn" class="action-btn" style="color: #ff3b30">删除</span>
            </div>
          </div>
        </div>

        <!-- 聊天消息区域 (保持不变) -->
        <div id="chat-messages"><div id="typing-indicator">对方正在输入...</div></div>

        <!-- 输入区域 (这是修改后的最终版本) -->
        <div id="chat-input-area">
          <div id="reply-preview-bar">
            <div class="reply-preview-content">
              <div class="sender">回复 xxx:</div>
              <div class="text">被引用的消息内容...</div>
            </div>
            <span id="cancel-reply-btn">×</span>
          </div>

          <div id="chat-input-actions-top">
            <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="表情面板">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>

            <!-- “重新生成回复”按钮的新家 -->
            <button id="reroll-btn" class="action-button" title="重新生成回复">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </button>

            <button id="quick-reply-btn" class="chat-action-icon-btn action-button" title="快捷回复">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <!-- 气泡轮廓 -->
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                <!-- 里面的两行文字线，代表预设内容 -->
                <line x1="8" y1="9" x2="16" y2="9"></line>
                <line x1="8" y1="13" x2="14" y2="13"></line>
              </svg>
            </button>

            <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="发送照片">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                <circle cx="12" cy="13" r="4" />
              </svg>
            </button>
            <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="上传图片">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <button id="transfer-btn" class="chat-action-icon-btn action-button" title="转账">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M7 4L12 12L17 4M12 12V20M8 10H16M8 13H16"></path>
              </svg>
            </button>
            <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="发送语音">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                <path d="M12 19v4" />
                <path d="M8 23h8" />
              </svg>
            </button>
            <button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title="发起外卖请求">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" />
                <line x1="3" y1="6" x2="21" y2="6" />
                <path d="M16 10a4 4 0 0 1-8 0" />
              </svg>
            </button>
            <button id="video-call-btn" class="chat-action-icon-btn action-button" title="视频通话">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
              </svg>
            </button>
            <button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="群视频通话">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </button>
            <button id="send-poll-btn" class="chat-action-icon-btn action-button" title="发起投票">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M8 6h10" />
                <path d="M6 6h.01" />
                <path d="M8 12h10" />
                <path d="M6 12h.01" />
                <path d="M8 18h10" />
                <path d="M6 18h.01" />
              </svg>
            </button>
            <button id="share-link-btn" class="chat-action-icon-btn action-button" title="分享链接">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path>
              </svg>
            </button>

            <button id="send-location-btn" class="chat-action-icon-btn action-button" title="发送定位">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
            </button>
          </div>
          <div id="chat-input-main-row">
            <textarea id="chat-input" rows="1" placeholder="输入消息..."></textarea>
            <div id="input-actions-wrapper">
              <button id="wait-reply-btn" title="等待回复">
                <img
                  src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png"
                  alt="等待回复"
                />
              </button>
              <button id="send-btn" class="action-button">发送</button>
            </div>
          </div>
        </div>

        <div id="chat-lock-overlay">
          <div id="chat-lock-content"></div>
        </div>

        <div id="sticker-panel">
          <div id="sticker-panel-header">
            <span class="panel-btn" id="close-sticker-panel-btn">取消</span>
            <span class="title">表情包</span>
            <!-- “编辑”和“完成”按钮 -->
            <div style="display: flex; gap: 10px">
              <span class="panel-btn" id="edit-user-stickers-btn">编辑</span>
              <span class="panel-btn" id="done-user-stickers-btn" style="display: none">完成</span>
              <span class="panel-btn" id="add-sticker-btn">添加</span>
              <span class="panel-btn" id="upload-sticker-btn">上传</span>
            </div>
          </div>
          <div id="sticker-grid"></div>

          <!-- 在 #sticker-panel 中，找到 id="sticker-panel-footer" -->

          <div id="sticker-category-tabs">
            <!-- 分类胶囊将由JS动态生成在这里 -->
          </div>

          <div id="sticker-panel-footer" style="display: none">
            <!-- 移动表情按钮 -->
            <button id="move-selected-stickers-btn">移动到分类...</button>
            <!-- 删除表情按钮 -->
            <button id="delete-selected-user-stickers-btn">删除已选 (0)</button>
          </div>
        </div>

        <input type="file" id="sticker-upload-input" accept="image/*" style="display: none" multiple />
        <input type="file" id="image-upload-input" accept="image/*" style="display: none" />


应该是【外观设置的功能】
    <!-- 外观设置页面 (已修复ID和布局) -->
    <div id="wallpaper-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>外观设置</span>
        <span style="width: 30px"></span>
      </div>

      <!-- 内容滚动区域 -->
      <div class="form-container settings-scroll-container">
        <!-- 1. 锁屏与安全卡片 -->
        <div class="settings-group-card">
          <div class="settings-section-title">🔒 锁屏与安全</div>

          <div class="setting-row">
            <label class="setting-label">启用锁屏界面</label>
            <label class="toggle-switch-label">
              <input type="checkbox" id="enable-lock-screen-toggle" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>

          <div class="setting-item">
            <label>锁屏密码 (留空则无)</label>
            <input type="text" id="password-set-input" class="moe-input" placeholder="设置解锁密码" />
          </div>

          <div class="setting-item">
            <label>锁屏壁纸</label>
            <div class="preview-upload-box">
              <div id="lockscreen-wallpaper-preview" class="mini-preview">预览</div>
              <button
                class="upload-btn-pill"
                onclick="document.getElementById('lockscreen-wallpaper-upload-input').click();"
              >
                更换壁纸
              </button>
            </div>
            <input type="file" id="lockscreen-wallpaper-upload-input" accept="image/*" hidden />
          </div>
        </div>
        <!-- 5. 高级美化 (CSS) 卡片 -->
        <div class="settings-group-card">
          <div class="settings-section-title">自定义css美化 (CSS)</div>

          <div class="setting-item">
            <div style="display: flex; gap: 5px; margin-bottom: 5px">
              <select id="theme-selector" class="moe-input select" style="flex: 1"></select>
              <button id="rename-theme-btn" class="btn-icon">✏️</button>
              <button id="delete-theme-btn" class="btn-icon danger">🗑️</button>
            </div>
            <textarea
              id="theme-css-editor"
              class="moe-input code-area"
              rows="6"
              placeholder="在此输入CSS代码..."
            ></textarea>
            <div class="css-actions">
              <button id="apply-theme-btn" class="upload-btn-pill primary">应用</button>
              <button id="save-theme-btn" class="upload-btn-pill">保存</button>
              <button id="save-as-new-theme-btn" class="upload-btn-pill">另存为</button>
              <button id="export-theme-btn" class="upload-btn-pill secondary">导出</button>
              <button id="import-theme-btn" class="upload-btn-pill secondary">导入</button>
              <input type="file" id="import-theme-input" accept=".json, .txt, .css, .docx" hidden />
            </div>
          </div>
        </div>

        <!-- 2. 主屏幕视觉卡片 -->
        <div class="settings-group-card">
          <div class="settings-section-title">📱 主屏幕视觉</div>

          <div class="setting-row">
            <label class="setting-label">显示状态栏</label>
            <label class="toggle-switch-label">
              <input type="checkbox" id="show-status-bar-toggle" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>

          <div class="setting-row">
            <label class="setting-label">夜间模式</label>
            <label class="toggle-switch-label">
              <!-- ★★★ 核心修复：ID 改回 theme-toggle-switch，解决报错 ★★★ -->
              <input type="checkbox" id="theme-toggle-switch" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>

          <div class="setting-row">
            <label class="setting-label">去除文字阴影</label>
            <label class="toggle-switch-label">
              <input type="checkbox" id="remove-home-font-shadow-toggle" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>

          <div class="setting-item">
            <label>主屏幕壁纸</label>
            <div class="preview-upload-box">
              <div id="wallpaper-preview" class="mini-preview">预览</div>
              <button class="upload-btn-pill" onclick="document.getElementById('wallpaper-upload-input').click();">
                更换壁纸
              </button>
            </div>
            <input type="file" id="wallpaper-upload-input" accept="image/*" hidden />
          </div>

          <div class="setting-item">
            <label>图标/组件字体颜色</label>
            <div class="color-picker-wrapper">
              <!-- 1. 颜色选择器 (保持原ID) -->
              <input type="color" id="home-icon-widget-text-color-picker" value="#FFFFFF" />

              <!-- 2. 文本输入框，允许手动输入颜色代码 -->
              <input
                type="text"
                id="home-icon-widget-text-color-input"
                placeholder="#FFFFFF"
                maxlength="7"
                spellcheck="false"
              />
            </div>
          </div>

          <!-- 主屏幕预设部分 -->
          <div class="setting-item">
            <label>主屏幕预设管理</label>
            <div class="preset-manager-container" style="margin-top: 5px; border: none; padding: 0">
              <div class="form-group">
                <select id="home-preset-selector" class="moe-input select"></select>
                <div class="preset-manager-controls compact">
                  <button id="apply-home-preset-btn" class="preset-btn-capsule preset-btn-apply" disabled>应用</button>
                  <button id="save-home-preset-btn" class="preset-btn-capsule preset-btn-save">保存当前</button>
                  <button id="update-home-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>
                    更新
                  </button>
                  <button id="rename-home-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>
                    重命名
                  </button>
                  <button id="delete-home-preset-btn" class="preset-btn-capsule preset-btn-delete" disabled>
                    删除
                  </button>
                  <button id="import-home-preset-btn" class="preset-btn-capsule preset-btn-secondary">导入</button>
                  <button id="export-home-preset-btn" class="preset-btn-capsule preset-btn-secondary" disabled>
                    导出
                  </button>
                  <input type="file" id="import-home-preset-input" accept=".json" hidden />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 3. App 图标与名称卡片 -->
        <div class="settings-group-card">
          <div class="settings-section-title">🎨 图标与名称</div>
          <div class="setting-item">
            <label>App 图标定制</label>
            <div id="icon-settings-grid" class="icon-grid-compact">
              <!-- JS生成 -->
            </div>
          </div>

          <div class="setting-item">
            <label>App 名称定制</label>
            <div id="icon-rename-grid" class="name-grid-compact">
              <!-- JS生成 -->
            </div>
            <button class="form-button-secondary small-btn" id="reset-app-names-btn">恢复默认名字</button>
          </div>
        </div>

        <!-- 4. 声音与背景卡片 -->
        <div class="settings-group-card">
          <div class="settings-section-title">🎵 声音与背景</div>

          <div class="setting-item">
            <label>来电铃声 URL</label>
            <input type="text" id="ringtone-url-input" class="moe-input" placeholder="音频链接..." />
          </div>

          <div class="setting-item">
            <label>提示音 URL</label>
            <input type="text" id="notification-sound-url-input" class="moe-input" placeholder="音频链接..." />
          </div>
          <!-- 4. 声音与背景卡片 -->
          <div class="settings-group-card">
            <div class="settings-section-title">🎵 声音与背景</div>

            <div class="setting-item">
              <label>来电铃声 URL</label>
              <input type="text" id="ringtone-url-input" class="moe-input" placeholder="音频链接..." />
            </div>

            <div class="setting-item">
              <label>提示音 URL</label>
              <input type="text" id="notification-sound-url-input" class="moe-input" placeholder="音频链接..." />
            </div>

            <div class="setting-item">
              <label>全局聊天背景</label>
              <div class="preview-upload-box">
                <!-- ★★★ 修改点：删除了 landscape 类名，现在它是竖屏的了 ★★★ -->
                <div id="global-bg-preview" class="mini-preview">预览</div>
                <div class="btn-col">
                  <button class="upload-btn-pill" onclick="document.getElementById('global-bg-upload-input').click();">
                    上传背景
                  </button>
                  <button class="upload-btn-pill danger" id="remove-global-bg-btn">移除背景</button>
                </div>
              </div>
              <input type="file" id="global-bg-upload-input" accept="image/*" hidden />
              <button
                class="form-button-secondary small-btn danger-text"
                id="clear-all-single-bgs-btn"
                style="margin-top: 10px"
              >
                一键清空所有单人聊天背景
              </button>
            </div>
          </div>
        </div>

        <!-- 底部留白，防止被保存按钮遮挡 -->
        <div style="height: 80px"></div>
      </div>

      <!-- ★★★ 悬浮保存按钮 ★★★ -->
      <button id="save-wallpaper-btn" class="moe-fab-save">
        💾<span style="font-size: 12px; display: block; margin-top: -2px">保存</span>
      </button>
    </div>












<script>
        apiConfig: {},
      const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
        apiKey,
          url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${getRandomValue(
            apiKey,
        const BLOCKED_API_SITES = ['api.pisces.ink', 'aiapi.qzz.io'];
          fontSize: 14,
          fontColor: '#FFFFFF',
            const apiUrl = `https://api.vkeys.cn/v2/music/netease?word=${encodeURIComponent(searchTerm)}`;
            console.log('正在尝试直接请求:', apiUrl); // 添加一条日志，方便我们调试
            const response = await fetch(apiUrl);
            const result = await Http_Get(`https://api.vkeys.cn/v2/music/tencent?word=${encodeURIComponent(name)}`);
              ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
              : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
                  ? `https://api.vkeys.cn/v2/music/netease?id=${fallbackResults[0].id}`
                  : `https://api.vkeys.cn/v2/music/tencent?id=${fallbackResults[0].id}`;
              ? `https://api.vkeys.cn/v2/music/netease/lyric?id=${songId}`
              : `https://api.vkeys.cn/v2/music/tencent/lyric?id=${songId}`;
          const apiUrl =
              ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
              : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
          const result = await Http_Get(apiUrl);
			#chat-settings-btn img {
			#api-settings-screen,
			#font-settings-screen,
			#world-book-screen,
			#world-book-editor-screen,
          'world-book': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
          qq: 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
          'api-settings': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
          font: 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg',
          'kk-checkin': 'https://i.postimg.cc/MGwrL0nf/kitty.png',
          studio: 'https://i.postimg.cc/W3sLz11s/clapperboard-icon.png',
          qq: 'QQ',
          'world-book': '世界书',
          'api-settings': 'API设置',
          font: '字体',
          'kk-checkin': 'kk查岗',
          studio: 'lrq小剧场',
        dynamicFontStyle.id = 'dynamic-font-style';
                ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
            '&id, isGroup, groupId, ownerId, isPinned, characterPhoneData, latestInnerVoice, innerVoiceHistory, loversSpaceData.emotionDiaries, settings.summary, settings.weiboNickname, settings.innerVoiceHideHeaderBorder, settings.innerVoiceAdopterLabelFormat, interactionStats, unlockedSymbols, settings.selectedIntimacyBadge',
          apiConfig: '&id',
          apiPresets: '++id, name, proxyUrl',
          fontPresets: '&id, name, url',
          datingPresets: '++id, name, settings.spriteGroupId',
          studioScripts: '++id, name',
          studioHistory: '++id, timestamp',
            case 'font-settings-screen':
          const presets = await db.fontPresets.toArray();
          const container = document.getElementById('font-preset-container');
          const presets = (await db.fontPresets.toArray()) || [];
            slot.className = 'font-preset-slot';
			                <div class="font-preview-text" data-preset-id="${preset.id}">Abc 你好</div>
			                <div class="font-preset-info">名称: ${preset.name}</div>
			                <div class="font-preset-actions">
			                <div class="font-preset-info">卡槽 ${i + 1} 为空</div>
			                <div class="font-preset-actions">
          const styleId = `font-style-${preset.id}`;
			        @font-face {
			            font-family: 'preset-${preset.id}';
			            font-display: swap;
			        .font-preview-text[data-preset-id="${preset.id}"] {
			            font-family: 'preset-${preset.id}', sans-serif !important;
          const input = document.getElementById('font-preset-local-upload');
            const presets = await db.fontPresets.toArray();
            const newPreset = { id: 'font_' + Date.now(), name, url };
            await db.transaction('rw', db.fontPresets, async () => {
              await db.fontPresets.clear();
              await db.fontPresets.bulkPut(presetsToSave);
          const preset = await db.fontPresets.get(presetId);
            await db.fontPresets.delete(presetId);
            const styleTag = document.getElementById(`font-style-${presetId}`);
          const preset = await db.fontPresets.get(presetId);
            state.globalSettings.fontUrl = preset.url;
         * 这个版本将优先查找您提供的 character_book 标准格式。
            settings: {
              fontSize: 13,
          // 策略一：【最高优先级】查找提供的 character_book 标准格式
            charData.character_book &&
            charData.character_book.entries &&
            Array.isArray(charData.character_book.entries) &&
            charData.character_book.entries.length > 0
            console.log(`检测到最新的 character_book 格式 (${charData.character_book.entries.length}条)，开始导入...`);
            await saveWorldBookEntriesFromArray(charData.character_book.entries, newCategoryId);
         * 从SillyTavern的 world_entries 或 character_book.entries 数组直接创建世界书
          if (screenId === 'api-settings-screen') {
          if (screenId === 'world-book-screen') {
          if (screenId === 'font-settings-screen') {
            document.getElementById('font-preview').style.fontFamily = '';
            applyCustomFont(state.globalSettings.fontUrl || '', true);
            const settings = state.qzoneSettings;
            document.getElementById('qzone-nickname').textContent = settings.nickname;
            document.getElementById('qzone-avatar-img').src = settings.avatar;
            document.getElementById('qzone-banner-img').src = settings.banner;
              authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
                authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                senderName = chat.isGroup ? chat.settings.myNickname || '我' : '我';
                senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                  senderAvatar = chat.settings.aiAvatar || defaultAvatar;
                    ...(chat.settings.stickerLibrary || []),
              apiConfig,
              apiPresets,
              fontPresets,
              db.apiConfig.get('main'),
              db.apiPresets.toArray(),
              db.fontPresets.toArray(),
              apiConfig,
              apiPresets,
              fontPresets,
            apiConfig,
            apiPresets,
            fontPresets,
            db.apiConfig.get('main'),
            db.apiPresets.toArray(),
            db.fontPresets.toArray(),
            apiConfig,
            apiPresets,
            fontPresets,
          let { githubToken, githubUsername, githubRepo, githubPath } = state.apiConfig;
            if (backupObj.apiConfig) {
              backupObj.apiConfig.apiKey = '';
              backupObj.apiConfig.githubToken = '';
              backupObj.apiConfig.minimaxApiKey = '';
          let { githubToken, githubUsername, githubRepo, githubPath } = state.apiConfig;
            const metaUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${githubPath}.meta`;
                const partInfoUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${partName}`;
                const blobUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/git/blobs/${partJson.sha}`;
              const singleUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${githubPath}`;
                const blobUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/git/blobs/${json.sha}`;
          const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
            const getRes = await fetch(apiUrl, {
          const res = await fetch(apiUrl, {
          if (state.apiConfig && state.apiConfig.githubAutoBackup) {
            const intervalMinutes = state.apiConfig.githubBackupInterval || 30;
              const mode = state.apiConfig.githubBackupMode || 'full';
                'apiPresets',
                'fontPresets',
                    itemsToPut.forEach(book => {
                      if (Array.isArray(book.content)) {
                        console.log(`检测到数组格式的世界书: "${book.name}"，正在转换为字符串...`);
                        const convertedEntries = book.content.map(entry => {
                        book.content = convertedEntries.join('\n\n---\n\n');
              const objectTables = ['apiConfig', 'globalSettings', 'musicLibrary', 'qzoneSettings'];
              const settings = (await db.globalSettings.get('main')) || { id: 'main' };
              settings.widgetData = data.homeScreenState;
              if (data.homeScreenState.wallpaper) settings.wallpaper = data.homeScreenState.wallpaper;
                settings.lockscreenWallpaper = data.homeScreenState.lockscreenWallpaper;
              if (data.homeScreenState.appIcons) settings.appIcons = data.homeScreenState.appIcons;
              await db.globalSettings.put(settings);
        function applyCustomFont(fontUrl, isPreviewOnly = false) {
          if (!fontUrl) {
            document.getElementById('font-preview').style.fontFamily = '';
          const fontName = 'custom-user-font';
			        @font-face {
			          font-family: '${fontName}';
			          src: url('${fontUrl}');
			          font-display: swap;
            const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
            previewStyle.id = 'preview-font-style';
            if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
            document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
			              font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
          state.globalSettings.fontUrl = '';
          const globalPreview = document.getElementById('font-preview');
          globalPreview.style.fontFamily = ''; // 移除内联样式
            apiConfig,
            apiPresets,
            db.apiConfig.get('main'),
            db.apiPresets.toArray(),
            if (chat.isGroup && (!chat.settings || !chat.settings.stickerLibrary)) {
              if (!chat.settings) chat.settings = {}; // 以防万一连settings都没有
              chat.settings.stickerLibrary = [];
            if (!chat.isGroup && (!chat.settings || !chat.settings.stickerLibrary)) {
              if (!chat.settings) chat.settings = {}; // 以防万一连settings都没有
              chat.settings.stickerLibrary = [];
            if (chat.settings && typeof chat.settings.innerVoiceAdopterLabelFormat === 'undefined') {
              chat.settings.innerVoiceAdopterLabelFormat = '领养人: {{user}}';
            if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) {
              if (!chat.settings) chat.settings = {}; // 以防万一连settings都没有
              chat.settings.aiAvatarLibrary = [];
            if (!chat.settings.summary) {
              chat.settings.summary = {
              (!chat.settings.weiboProfession || typeof chat.settings.weiboInstruction === 'undefined')
              chat.settings.weiboProfession = '';
              chat.settings.weiboInstruction = '';
            if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
              chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
              delete chat.settings.linkedWorldBookId;
            if (chat.isGroup && (!chat.settings || typeof chat.settings.backgroundActivity === 'undefined')) {
              if (!chat.settings) chat.settings = {}; // 以防万一连settings都没有
              chat.settings.backgroundActivity = {
            if (typeof chat.settings.isCoupleAvatar === 'undefined') {
              chat.settings.isCoupleAvatar = false;
              chat.settings.coupleAvatarDescription = '';
            if (!chat.isGroup && typeof chat.settings.petAdopted === 'undefined') {
              if (chat.settings.pet && chat.settings.pet.type !== '无') {
                chat.settings.petAdopted = true;
                chat.settings.petAdopted = false;
              console.log(`为角色 "${chat.name}" 初始化了宠物领养状态: ${chat.settings.petAdopted}`);
            if (!chat.isGroup && chat.settings.pet) {
              if (typeof chat.settings.pet.persona === 'undefined') {
                chat.settings.pet.persona = '一只可爱的小宠物，对世界充满好奇。';
              if (!chat.settings.pet.petChatHistory) {
                chat.settings.pet.petChatHistory = [];
              if (!chat.settings.pet.status) {
                chat.settings.pet.status = {
                if (typeof chat.settings.pet.status.intimacyToUser === 'undefined')
                  chat.settings.pet.status.intimacyToUser = 50;
                if (typeof chat.settings.pet.status.intimacyToChar === 'undefined')
                  chat.settings.pet.status.intimacyToChar = 50;
                if (typeof chat.settings.pet.status.lastUpdated === 'undefined')
                  chat.settings.pet.status.lastUpdated = Date.now();
            if (!chat.settings.linkedMemories) {
              chat.settings.linkedMemories = [];
            if (typeof chat.settings.linkMemoryDepth === 'undefined') {
              chat.settings.linkMemoryDepth = 5;
            if (!chat.settings.offlineMode) {
              chat.settings.offlineMode = {
              if (!chat.settings.weiboNickname) {
                chat.settings.weiboNickname = chat.name; // 默认使用角色名作为微博昵称
              if (!chat.settings.weiboAvatar) {
                chat.settings.weiboAvatar = chat.settings.aiAvatar; // 默认使用AI头像
              if (!chat.settings.weiboAvatarFrame) {
                chat.settings.weiboAvatarFrame = chat.settings.aiAvatarFrame || ''; // 默认使用AI头像框
              if (!chat.settings.weiboBackground) {
                chat.settings.weiboBackground = 'https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg'; // 给一个默认背景
              (!chat.settings.weiboProfession || typeof chat.settings.weiboInstruction === 'undefined')
              chat.settings.weiboProfession = '';
              chat.settings.weiboInstruction = '';
              (typeof chat.settings.weiboFansCount === 'undefined' ||
                typeof chat.settings.weiboFollowingCount === 'undefined')
              chat.settings.weiboFansCount = initialStats.fans;
              chat.settings.weiboFollowingCount = initialStats.following;
            if (!chat.isGroup && (!chat.settings || typeof chat.settings.minimaxVoiceId === 'undefined')) {
              if (!chat.settings) chat.settings = {};
              chat.settings.minimaxVoiceId = ''; // 默认为空
            if (!chat.settings.streak) {
              chat.settings.streak = {
            } else if (typeof chat.settings.streak.extinguishThreshold === 'undefined') {
              chat.settings.streak.extinguishThreshold = 1;
              if (typeof chat.settings.groupAnnouncement === 'undefined') {
                chat.settings.groupAnnouncement = '';
              if (chat.settings) {
                if (typeof chat.settings.isUserAdmin === 'undefined') {
                  chat.settings.isUserAdmin = false;
                if (typeof chat.settings.myGroupTitle === 'undefined') {
                  chat.settings.myGroupTitle = '';
            if (!chat.settings.innerVoiceStyles) {
              chat.settings.innerVoiceStyles = {
            if (chat.settings.innerVoiceStyles && typeof chat.settings.innerVoiceStyles.iconColor === 'undefined') {
              chat.settings.innerVoiceStyles.iconColor = '#ff8a80'; // 默认粉红色
            if (chat.settings && typeof chat.settings.selectedIntimacyBadge === 'undefined') {
              chat.settings.selectedIntimacyBadge = ''; // 默认为空，不佩戴
            if (!chat.isGroup && chat.settings) {
              if (typeof chat.settings.language_boost === 'undefined') {
                chat.settings.language_boost = null; // 默认为null
              if (typeof chat.settings.speed === 'undefined') {
                chat.settings.speed = 1.0; // 默认为1.0
          state.apiConfig = apiConfig || {
            apiKey: '',
          if (typeof state.apiConfig.temperature === 'undefined') {
            state.apiConfig.temperature = 0.8;
            fontUrl: '',
          state.apiPresets = apiPresets || [];
            chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar;
          const songsToCheck = musicState.playlist.filter(track => track.src && track.src.includes('api.vkeys.cn'));
          modelSelect.value = state.apiConfig.minimaxSpeechModel || 'speech-01-turbo';
          const settings = getNovelAISettings();
          document.getElementById('nai-resolution').value = settings.resolution;
          document.getElementById('nai-steps').value = settings.steps;
          document.getElementById('nai-cfg-scale').value = settings.cfg_scale;
          document.getElementById('nai-sampler').value = settings.sampler;
          document.getElementById('nai-seed').value = settings.seed;
          document.getElementById('nai-uc-preset').value = settings.uc_preset;
          document.getElementById('nai-quality-toggle').checked = settings.quality_toggle;
          document.getElementById('nai-smea').checked = settings.smea;
          document.getElementById('nai-smea-dyn').checked = settings.smea_dyn;
          document.getElementById('nai-default-positive').value = settings.default_positive;
          document.getElementById('nai-default-negative').value = settings.default_negative;
          document.getElementById('nai-cors-proxy').value = settings.cors_proxy;
          document.getElementById('nai-custom-proxy-url').value = settings.custom_proxy_url || '';
          customProxyGroup.style.display = settings.cors_proxy === 'custom' ? 'block' : 'none';
          const novelaiApiKey = document.getElementById('novelai-api-key').value.trim();
          localStorage.setItem('novelai-api-key', novelaiApiKey);
          const settings = {
          localStorage.setItem('novelai-settings', JSON.stringify(settings));
          localStorage.removeItem('novelai-settings');
          const saved = localStorage.getItem('novelai-settings');
          const naiSettings = chat.settings.naiSettings || {};
          const apiKey = document.getElementById('novelai-api-key').value.trim();
          if (!apiKey) {
          const settings = getNovelAISettings();
          const apiKey = document.getElementById('novelai-api-key').value.trim();
          if (!apiKey) {
          const settings = getNovelAISettings();
            const [width, height] = settings.resolution.split('x').map(Number);
                  scale: settings.cfg_scale,
                  sampler: settings.sampler,
                  steps: settings.steps,
                  seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                  ucPreset: settings.uc_preset,
                  qualityToggle: settings.quality_toggle,
                  scale: settings.cfg_scale,
                  sampler: settings.sampler,
                  steps: settings.steps,
                  seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                  ucPreset: settings.uc_preset,
                  qualityToggle: settings.quality_toggle,
                  sm: settings.smea,
                  sm_dyn: settings.smea_dyn,
            let apiUrl;
              apiUrl = 'https://image.novelai.net/ai/generate-image-stream';
              apiUrl = 'https://image.novelai.net/ai/generate-image';
            let corsProxy = settings.cors_proxy;
              corsProxy = settings.custom_proxy_url || '';
              apiUrl = corsProxy + encodeURIComponent(apiUrl);
                Authorization: 'Bearer ' + apiKey,
            const response = await fetch(apiUrl, fetchOptions);
          document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || '';
          document.getElementById('api-key').value = state.apiConfig.apiKey || '';
          document.getElementById('minimax-group-id').value = state.apiConfig.minimaxGroupId || '';
          document.getElementById('minimax-api-key').value = state.apiConfig.minimaxApiKey || '';
          document.getElementById('minimax-provider-select').value = state.apiConfig.minimaxProvider || 'cn';
            const savedSpeechModel = state.apiConfig.minimaxSpeechModel || 'speech-01-turbo';
            const savedModel = state.apiConfig.model || 'gpt-4';
          const novelaiApiKey = localStorage.getItem('novelai-api-key') || '';
          document.getElementById('novelai-api-key').value = novelaiApiKey;
          document.getElementById('github-token').value = state.apiConfig.githubToken || '';
          document.getElementById('github-username').value = state.apiConfig.githubUsername || '';
          document.getElementById('github-repo').value = state.apiConfig.githubRepo || '';
          document.getElementById('github-path').value = state.apiConfig.githubPath || 'ephone_backup.json';
          document.getElementById('github-auto-backup-switch').checked = !!state.apiConfig.githubAutoBackup;
          document.getElementById('github-backup-mode').value = state.apiConfig.githubBackupMode || 'full';
          document.getElementById('github-backup-interval').value = state.apiConfig.githubBackupInterval || 30;
          const currentTemp = state.apiConfig.temperature || 0.8;
          const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
          if (!chat.isGroup && chat.settings.streak && chat.settings.streak.enabled) {
            const streak = chat.settings.streak;
            const fontColor = streak.fontColor || '#ff6f00';
                streakHtml = `<span class="streak-indicator" style="color: ${fontColor};">${iconHtml}</span>`;
                streakHtml = `<span class="streak-indicator" style="color: ${fontColor};">${iconHtml}∞</span>`;
                streakHtml = `<span class="streak-indicator" style="color: ${fontColor};">${iconHtml}${streak.currentDays}</span>`;
          if (!chat.isGroup && chat.settings.selectedIntimacyBadge) {
            selectedBadgeHtml = `<span class="intimacy-badge-display"><img src="${chat.settings.selectedIntimacyBadge}" alt="badge"></span>`;
                      }; font-style: italic;">${lastMsgDisplay}</div>
          messagesContainer.dataset.theme = chat.settings.theme || 'default';
          const fontSize = chat.settings.fontSize || 13;
          messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
          applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
			                    <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
          const backgroundToApply = chat.settings.background || state.globalSettings.globalChatBackground;
          chatScreen.style.backgroundColor = chat.settings.background
          document.getElementById('remove-home-font-shadow-toggle').checked =
          const listEl = document.getElementById('world-book-list');
          const [books, categories] = await Promise.all([
          state.worldBooks = books; // 确保内存中的数据是同步的
          if (books.length === 0) {
          const groupedBooks = books.reduce((acc, book) => {
            const key = book.categoryId || 'uncategorized';
            acc[key].push(book);
            const booksInCategory = groupedBooks[category.id];
            if (booksInCategory && booksInCategory.length > 0) {
              const groupContainer = createWorldBookGroup(category.name, booksInCategory);
          document.querySelectorAll('.world-book-group-header').forEach(header => {
         * @param {Array} books - 该分类下的书籍数组
        function createWorldBookGroup(groupName, books) {
          groupContainer.className = 'world-book-group-container';
			        <div class="world-book-group-header">
			        <div class="world-book-group-content"></div>
          const headerEl = groupContainer.querySelector('.world-book-group-header');
          const contentEl = groupContainer.querySelector('.world-book-group-content');
          books.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));
          books.forEach(book => {
            item.dataset.bookId = book.id;
            item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(
              book.content || '暂无内容...'
            item.addEventListener('click', () => openWorldBookEditor(book.id));
                `确定要删除《${book.name}》吗？此操作不可撤销。`,
                await db.worldBooks.delete(book.id);
                state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id);
        async function openWorldBookEditor(bookId) {
          editingWorldBookId = bookId;
          const [book, categories] = await Promise.all([db.worldBooks.get(bookId), db.worldBookCategories.toArray()]);
          if (!book) return;
          document.getElementById('world-book-editor-title').textContent = book.name;
          document.getElementById('world-book-name-input').value = book.name;
          document.getElementById('world-book-content-input').value = book.content;
          const selectEl = document.getElementById('world-book-category-select');
            if (book.categoryId === cat.id) {
          showScreen('world-book-editor-screen');
			                            <div style="font-weight:bold; color:#5f6368;">📝 旁白</div>
              senderDisplayName = chat.settings.myNickname || '我';
              else if (chat.settings.isUserAdmin) {
              if (chat.settings.myGroupTitle) {
                titleTag.textContent = chat.settings.myGroupTitle;
              avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
              avatarFrameSrc = chat.settings.myAvatarFrame || ''; // <--- 获取“我”的头像框
              avatarSrc = chat.settings.myAvatar || defaultAvatar;
              avatarFrameSrc = chat.settings.myAvatarFrame || ''; // <--- 获取“我”的头像框
              avatarSrc = chat.settings.aiAvatar || defaultAvatar;
              avatarFrameSrc = chat.settings.aiAvatarFrame || ''; // <--- 获取AI的头像框
			                <p class="greeting" style="font-weight: bold; font-size: 16px;">${payload.foodName}</p>
			                <p style="font-size: 13px; color: #888;">你的专属外卖已送达</p>
			                <p class="greeting" style="font-weight: bold; font-size: 16px;">${payload.foodName}</p>
			                <p style="font-size: 13px; color: #888;">来自: ${payload.restaurant}</p>
            const myNickname = currentChat.settings.myNickname || '我';
            const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
            const myNickname = chat.settings.myNickname || '我';
            const senderName = isUserSender ? chat.settings.myNickname || '我' : chat.name;
            const receiverName = isUserSender ? chat.name : chat.settings.myNickname || '我';
			                            <p style="font-size:14px; color:#555; margin:15px 0;">等待对方同意...</p>
			                            <p style="font-size:14px; color:#555; margin:15px 0;">开启后可以记录你们的专属回忆哦~</p>
			                        <p style="font-size:14px; color:#555; margin:15px 0;">你们的情侣空间已成功开启！</p>
			                    <span class="icon" style="font-size: 20px;">💌</span>
            const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
            senderName = chat.isGroup ? chat.settings.myNickname || '我' : '我';
          if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds
                const book = state.worldBooks.find(b => b.id === id);
                return book && book.content ? `\n\n## 世界书条目: ${book.name}\n${stripHtmlAndCode(book.content)}` : '';
          if (!chat.isGroup && chat.settings.offlineMode && chat.settings.offlineMode.enabled) {
            const offlineSettings = chat.settings.offlineMode;
            ${chat.settings.aiPersona}
              .slice(-chat.settings.maxMemory)
            const messagesForOfflineMode = chat.history.slice(-chat.settings.maxMemory);
              const { proxyUrl, apiKey, model } = state.apiConfig;
                ? `${GEMINI_API_URL}/${model}:generateContent?key=${getRandomValue(apiKey)}`
                : { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` };
                  generationConfig: { temperature: parseFloat(state.apiConfig.temperature) || 0.8 },
                  temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                      const apiKey = localStorage.getItem('novelai-api-key');
                      const settings = getNovelAISettings();
                      if (!apiKey) throw new Error('未配置NovelAI API Key');
                      const [width, height] = settings.resolution.split('x').map(Number);
                      let apiUrl = model.includes('nai-diffusion-4')
                        scale: settings.cfg_scale,
                        sampler: settings.sampler,
                        steps: settings.steps,
                        ucPreset: settings.uc_preset,
                        qualityToggle: settings.quality_toggle,
                            sm: settings.smea,
                            sm_dyn: settings.smea_dyn,
                        settings.cors_proxy === 'custom' ? settings.custom_proxy_url : settings.cors_proxy;
                      if (corsProxy) apiUrl = corsProxy + encodeURIComponent(apiUrl);
                      let headers = { 'Content-Type': 'application/json', Authorization: 'Bearer ' + apiKey };
                      const res = await fetch(apiUrl, { method: 'POST', headers, body: JSON.stringify(requestBody) });
          const exclusiveStickers = chat.settings.stickerLibrary || [];
          const { proxyUrl, apiKey, model } = state.apiConfig;
          } else if (chat.settings.offlineMode?.enabled) {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
			- **你的角色设定**: ${chat.settings.aiPersona}
                let geminiConfig = toGeminiRequestData(model, apiKey, '', messagesForDecision, isGemini);
                      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                        temperature: parseFloat(state.apiConfig.temperature) || 0.8,
            const historySlice = chat.history.filter(msg => !msg.isTemporary).slice(-chat.settings.maxMemory); // 1. 【修复】把这行加回来！
            if (chat.settings.timePerceptionEnabled ?? true) {
              if (chat.settings.customTime) {
                now = new Date(chat.settings.customTime);
            if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
              const linkedContents = chat.settings.linkedWorldBookIds
                .map(bookId => {
                  const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            if (chat.settings.linkedMemories && chat.settings.linkedMemories.length > 0) {
              const contextPromises = chat.settings.linkedMemories.map(async link => {
                    msg.senderName || (msg.role === 'user' ? chat.settings.myNickname || '我' : '未知发送者');
              const myNickname = chat.settings.myNickname || '我';
              const announcement = chat.settings.groupAnnouncement || '';
			- **${myNickname}**: ${chat.settings.myPersona}
                  const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
                        ...(chat.settings.stickerLibrary || []),
              if (chat.settings.isCoupleAvatar) {
                if (chat.settings.coupleAvatarDescription) {
                  coupleAvatarContext = `\n# 关于情侣头像的重要信息\n- 你和用户正在使用情侣头像。\n- 这对情侣头像是这样的：${chat.settings.coupleAvatarDescription}。`;
              if (chat.settings.pet && chat.settings.pet.type !== '无') {
                const pet = chat.settings.pet;
                    textBodyEl.innerHTML = `${partBefore}<span style="color: #00ffea; text-shadow: 0 0 8px rgba(0, 255, 234, 0.4); font-weight: 500;">${partActive}</span>${partAfter}`;
			- **核心人设**: ${chat.settings.aiPersona}
			    - **职业**: ${chat.settings.weiboProfession || '无'}
			    - **特殊指令**: ${chat.settings.weiboInstruction || '无特殊指令'}
        chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0
          ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n')
			-   **分享书籍**: \`{"type": "ls_share", "shareType": "book", "title": "书名", "summary": "在这里写下这本书的简介...", "thoughts": "在这里写下你分享这本书的感想..."}\`
			${chat.settings.myPersona}
            let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload, isGemini);
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                    ...(chat.settings.stickerLibrary || []),
                  const myNickname = chat.settings.myNickname || '我';
                    chat.settings.myGroupTitle = newTitle.trim();
                  const myNickname = chat.settings.myNickname || '我'; // 获取你自己的昵称
                    chat.settings.isUserAdmin = isAdmin;
                  chat.settings.groupAnnouncement = newAnnouncement;
                    authorAvatar: chat.settings.aiAvatar || defaultAvatar,
                  const pet = chat.settings.pet;
                  if (!chat.isGroup && chat.settings.pet && chat.settings.pet.type !== '无') {
                    const pet = chat.settings.pet;
                      senderAvatar: chat.settings.aiAvatar,
                      recipientName: chat.settings.myNickname || '我',
                      recipientAvatar: chat.settings.myAvatar,
                        const apiKey = localStorage.getItem('novelai-api-key');
                        const settings = getNovelAISettings();
                        if (!apiKey) {
                        const [width, height] = settings.resolution.split('x').map(Number);
                              scale: settings.cfg_scale,
                              sampler: settings.sampler,
                              steps: settings.steps,
                              seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                              ucPreset: settings.uc_preset,
                              qualityToggle: settings.quality_toggle,
                              scale: settings.cfg_scale,
                              sampler: settings.sampler,
                              steps: settings.steps,
                              seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                              ucPreset: settings.uc_preset,
                              qualityToggle: settings.quality_toggle,
                              sm: settings.smea,
                              sm_dyn: settings.smea_dyn,
                        let apiUrl;
                          apiUrl = 'https://image.novelai.net/ai/generate-image-stream';
                          apiUrl = 'https://image.novelai.net/ai/generate-image';
                        let corsProxy = settings.cors_proxy;
                          corsProxy = settings.custom_proxy_url || '';
                          apiUrl = corsProxy + encodeURIComponent(apiUrl);
                        const response = await fetch(apiUrl, {
                            Authorization: 'Bearer ' + apiKey,
                    const apiKey = localStorage.getItem('novelai-api-key');
                    const settings = getNovelAISettings();
                    if (!apiKey) {
                    const [width, height] = settings.resolution.split('x').map(Number);
                          scale: settings.cfg_scale,
                          sampler: settings.sampler,
                          steps: settings.steps,
                          seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                          ucPreset: settings.uc_preset,
                          qualityToggle: settings.quality_toggle,
                          scale: settings.cfg_scale,
                          sampler: settings.sampler,
                          steps: settings.steps,
                          seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                          ucPreset: settings.uc_preset,
                          qualityToggle: settings.quality_toggle,
                          sm: settings.smea,
                          sm_dyn: settings.smea_dyn,
                    let apiUrl;
                      apiUrl = 'https://image.novelai.net/ai/generate-image-stream';
                      apiUrl = 'https://image.novelai.net/ai/generate-image';
                    let corsProxy = settings.cors_proxy;
                      corsProxy = settings.custom_proxy_url || '';
                      apiUrl = corsProxy + encodeURIComponent(apiUrl);
                    const response = await fetch(apiUrl, {
                        Authorization: 'Bearer ' + apiKey,
                    const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
                  const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
                    chat.settings.aiAvatar = foundAvatar.url;
                        (originalMessage.role === 'user' ? chat.settings.myNickname || '我' : chat.name),
                    ...(chat.settings.stickerLibrary || []),
                        ...(chat.settings.stickerLibrary || []),
          const senderName = chat.isGroup ? chat.settings.myNickname || '我' : '我';
          iconImg.src = 'https://cdn.jsdelivr.net.cn/gh/qdqqd/tc_temp/jli60izy2n.png';
              charAvatarEl.src = chat.settings.groupAvatar || defaultGroupAvatar;
              charAvatarEl.src = chat.settings.aiAvatar || defaultAvatar;
            userAvatarEl.src = chat.settings.myAvatar || defaultAvatar;
                const apiUrl =
                    ? `https://api.vkeys.cn/v2/music/netease?id=${track.musicId}`
                    : `https://api.vkeys.cn/v2/music/tencent?id=${track.musicId}`;
                const res = await Http_Get(apiUrl);
          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) return;
          const maxMemory = chat.settings.maxMemory || 10;
                    ? chat.settings.myNickname || '我'
          if (chat.settings.linkedMemories && chat.settings.linkedMemories.length > 0) {
            const contextPromises = chat.settings.linkedMemories.map(async link => {
          if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds
              .map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
			-   **【新】在情侣空间分享书籍**: \`[{"type": "ls_share", "shareType": "book", "title": "书名", "summary": "在这里写下这本书的简介...", "thoughts": "在这里写下你分享这本书的感想..."}]\`
			-   **你的角色设定**: ${chat.settings.aiPersona}
			    - 你的微博职业: ${chat.settings.weiboProfession || '无'}
			    - 你的微博指令: ${chat.settings.weiboInstruction || '无特殊指令'}
            let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload, isGemini);
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  authorAvatar: chat.settings.aiAvatar || defaultAvatar,
         * @param {string} scopeId 应用样式的作用域ID (例如 '#chat-messages' 或 '#settings-preview-area')
          const previewArea = document.getElementById('settings-preview-area');
          const fontSize = document.getElementById('font-size-slider').value;
          const background = chat.settings.background; // 直接获取背景设置
          previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);
          applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
              if (currentChat.settings.stickerLibrary) {
                allStickers.push(...currentChat.settings.stickerLibrary);
                avatar: c.settings.aiAvatar || defaultAvatar,
              contact.isNpc ? '<span style="color: #888; font-size: 12px;">(NPC)</span>' : ''
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || '',
            settings: {
              fontSize: 13,
              avatar: chat.settings.myAvatar || defaultMyGroupAvatar,
              groupNickname: chat.settings.myNickname || '我',
              groupTitle: chat.settings.myGroupTitle || '',
            const isAAdmin = a.id === 'user' ? chat.settings.isUserAdmin : a.isAdmin;
            const isBAdmin = b.id === 'user' ? chat.settings.isUserAdmin : b.isAdmin;
          const isCurrentUserAdmin = chat.settings.isUserAdmin;
          const isThisMemberAdmin = (member.id === 'user' && chat.settings.isUserAdmin) || member.isAdmin;
          const titleText = member.id === 'user' ? chat.settings.myGroupTitle || '' : member.groupTitle || '';
          const isAdmin = chat.settings.isUserAdmin;
            targetMember = { id: 'user', ...chat.settings }; // 构造一个临时的“成员”对象代表用户
            // 如果操作的是用户自己，就更新 chat.settings.isUserMuted
            if (typeof chat.settings.isUserMuted === 'undefined') chat.settings.isUserMuted = false;
            chat.settings.isUserMuted = !chat.settings.isUserMuted;
          const myNickname = chat.settings.myNickname || '我';
          const targetNickname = memberId === 'user' ? chat.settings.myNickname || '我' : targetMember.groupNickname;
          const actionText = (memberId === 'user' ? chat.settings.isUserMuted : targetMember.isMuted)
          if (!chat || !chat.settings.isUserMuted) return;
            chat.settings.isUserMuted = false;
            await logSystemMessage(chat.id, `“${chat.settings.myNickname || '我'}”为自己解除了禁言。`);
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || '',
          const myNickname = chat.settings.myNickname || '我';
          const oldNickname = chat.settings.myNickname || '我';
            chat.settings.myNickname = newNickname.trim();
          const oldTitle = chat.settings.myGroupTitle || '';
            chat.settings.myGroupTitle = newTitle.trim();
            const myNickname = chat.settings.myNickname || '我';
          const isAdmin = chat.settings.isUserAdmin;
            const myNickname = chat.settings.myNickname || '我';
                avatar: c.settings.aiAvatar || defaultAvatar,
                contact.isNpc ? '<span style="color: #888; font-size: 12px;">(NPC)</span>' : ''
          const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
            document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
            document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || '我';
            document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
                `${msg.role === 'user' ? chat.settings.myNickname || '我' : msg.senderName || chat.name}: ${String(
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
			用户 (${chat.settings.myNickname || '我'}) 刚刚发起了群视频通话。
			你正在扮演角色 "${chat.name}"。用户 (${chat.settings.myNickname || '我'}) 刚刚向你发起了视频通话请求。
			${chat.settings.aiPersona}
            let geminiConfig = toGeminiRequestData(model, apiKey, systemPromptForCall, messagesForApi, isGemini);
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                `${msg.role === 'user' ? chat.settings.myNickname || '我' : msg.senderName || chat.name}: ${String(
          if (chat.settings.visualVideoCallEnabled) {
            document.querySelector('#video-main-view img').src = chat.settings.charVideoImage || defaultAvatar;
            document.querySelector('#video-pip-view img').src = chat.settings.userVideoImage || defaultAvatar;
                  name: chat.settings.myNickname || '我',
                  avatar: chat.settings.myAvatar || defaultMyGroupAvatar,
              participantsData.push({ name: chat.name, avatar: chat.settings.aiAvatar || defaultAvatar });
              participantsData.unshift({ name: '我', avatar: chat.settings.myAvatar || defaultAvatar });
              .map(h => `${h.role === 'user' ? chat.settings.myNickname || '我' : h.role}: ${h.content}`)
              ? chat.settings.groupAvatar || defaultGroupAvatar
              : chat.settings.aiAvatar || defaultAvatar;
                name: chat.settings.myNickname || '我',
                avatar: chat.settings.myAvatar || defaultMyGroupAvatar,
              avatar: chat.settings.aiAvatar || defaultAvatar,
            document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
            document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
          const { proxyUrl, apiKey, model } = state.apiConfig;
          const isVisualMode = chat.settings.visualVideoCallEnabled;
          const userNickname = chat.settings.myNickname || '我';
          if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds
              .map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            let geminiConfig = toGeminiRequestData(model, apiKey, inCallPrompt, messagesForApi, isGemini);
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
              chat.settings.videoCallVoiceAccess &&
              state.apiConfig.minimaxGroupId &&
              state.apiConfig.minimaxApiKey &&
              chat.settings.minimaxVoiceId &&
              playMinimaxAudio(sanitizedResponse, chat.settings.minimaxVoiceId, [bubble]);
          const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
          const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) {
              const sender = msg.role === 'user' ? chat.settings.myNickname || '我' : msg.senderName || chat.name;
          if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds
              .map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
			${chat.settings.aiPersona}
            let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
          const myNickname = chat.settings.myNickname || '我';
          const myNickname = chat.settings.myNickname || '我';
          const myNickname = freshChat.settings.myNickname || '我';
          const myNickname = chat.settings.myNickname || '我';
          const myNickname = chat.settings.myNickname || '我';
          const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
          const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
			                    <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}票)</p>
			                    <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
          const library = chat.settings.aiAvatarLibrary || [];
                chat.settings.aiAvatarLibrary.splice(index, 1);
          if (!chat.settings.aiAvatarLibrary) {
            chat.settings.aiAvatarLibrary = [];
          chat.settings.aiAvatarLibrary.push({ name: name.trim(), url: finalUrl.trim() });
          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) {
          const maxMemory = chat.settings.maxMemory || 10;
                    ? chat.settings.myNickname || '我'
          if (chat.settings.linkedMemories && chat.settings.linkedMemories.length > 0) {
            const contextPromises = chat.settings.linkedMemories.map(async link => {
            const myNickname = chat.settings.myNickname || '我';
            if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
              const linkedContents = chat.settings.linkedWorldBookIds
                .map(bookId => {
                  const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            )} 分钟，用户(昵称: "${chat.settings.myNickname || '我'}")不在线。
			- **${myNickname}**: ${chat.settings.myPersona}
            let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload, isGemini);
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
              chat.settings.backgroundActivity.lastActivityTimestamp = Date.now();
          // 加长检查间隔，防止已经触发自动回复但api未返回时重复触发导致多次回复。60秒间隔大于一般API返回数据时间的平均值，且不会过长影响使用体验。
            const bgSettings = chat.settings.backgroundActivity;
          const grid = document.getElementById('icon-settings-grid');
            'world-book': '世界书',
            qq: 'QQ',
            'api-settings': 'API设置',
            font: '字体',
            'kk-checkin': 'kk查岗',
            studio: 'lrq小剧场',
            item.className = 'icon-setting-item';
            senderName: message.senderName || (message.role === 'user' ? chat.settings.myNickname || '我' : chat.name),
                    chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar
          document.getElementById('world-book-category-manager-modal').classList.add('visible');
            const booksToUpdate = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
            for (const book of booksToUpdate) {
              book.categoryId = null;
              await db.worldBooks.put(book);
              const bookInState = state.worldBooks.find(wb => wb.id === book.id);
              if (bookInState) bookInState.categoryId = null;
            currentFrameUrl = charChat.settings.weiboAvatarFrame || '';
            previewAvatarUrl = charChat.settings.weiboAvatar || defaultAvatar;
            currentFrameUrl = chat.settings.aiAvatarFrame || '';
            previewAvatarUrl = chat.settings.aiAvatar || defaultAvatar;
            currentFrameUrl = chat.settings.myAvatarFrame || '';
            previewAvatarUrl = chat.settings.myAvatar || defaultAvatar;
              charChat.settings.weiboAvatarFrame = url;
              chat.settings.aiAvatarFrame = url;
              chat.settings.myAvatarFrame = url;
          const selectEl = document.getElementById('api-preset-select');
          if (state.apiPresets) {
            state.apiPresets.forEach(preset => {
          const { proxyUrl, apiKey } = state.apiConfig;
          const matchingPreset = state.apiPresets
            ? state.apiPresets.find(p => p.proxyUrl === proxyUrl && p.apiKey === apiKey)
          const selectEl = document.getElementById('api-preset-select');
          const apiKeyInput = document.getElementById('api-key');
          if (selectedId && state.apiPresets) {
            const selectedPreset = state.apiPresets.find(p => p.id === selectedId);
              apiKeyInput.value = selectedPreset.apiKey;
          const selectEl = document.getElementById('api-preset-select');
          const selectedPreset = state.apiPresets ? state.apiPresets.find(p => p.id === selectedId) : null;
          const apiKey = document.getElementById('api-key').value.trim();
          if (!proxyUrl || !apiKey) {
            const newPreset = { name: name.trim(), proxyUrl, apiKey };
            const newId = await db.apiPresets.add(newPreset);
            if (!state.apiPresets) state.apiPresets = [];
            state.apiPresets.push({ id: newId, ...newPreset });
            document.getElementById('api-preset-select').value = newId;
          const apiKey = document.getElementById('api-key').value.trim();
          if (!proxyUrl || !apiKey) {
          const preset = state.apiPresets.find(p => p.id === presetId);
            preset.apiKey = apiKey;
            await db.apiPresets.put(preset);
          const preset = state.apiPresets.find(p => p.id === presetId);
              await db.apiPresets.delete(presetId);
              state.apiPresets = state.apiPresets.filter(p => p.id !== presetId);
            if (e.target.closest('#lyrics-settings-btn') || e.target.closest('.close-btn')) {
          bar.style.fontSize = `${lyricsBarSettings.fontSize}px`;
          bar.style.color = lyricsBarSettings.fontColor;
          document.getElementById('lyrics-font-size-slider').value = lyricsBarSettings.fontSize;
          document.getElementById('lyrics-font-size-value').textContent = `${lyricsBarSettings.fontSize}px`;
          document.getElementById('lyrics-font-color-picker').value = lyricsBarSettings.fontColor;
			            <img src="${char.settings.aiAvatar || defaultAvatar}" alt="${char.name}">
                persona: otherChat.settings.aiPersona,
                avatar: otherChat.settings.aiAvatar || defaultAvatar,
			                                    <span style="font-size:12px; color:#888;">${opt.type}</span>
            const persona = (chat.settings.aiPersona || '').substring(0, 4000);
            const maxMemory = chat.settings.maxMemory || 20;
            if (chat.settings.linkedMemories && chat.settings.linkedMemories.length > 0) {
              const contextPromises = chat.settings.linkedMemories.map(async link => {
            if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                chat.settings.linkedWorldBookIds
                    const book = state.worldBooks.find(b => b.id === id);
                    return book ? `[${book.name}]: ${book.content}` : '';
            const { proxyUrl, apiKey, model } = state.apiConfig;
              apiKey,
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
            const persona = (chat.settings.aiPersona || '').substring(0, 4000);
              .slice(-chat.settings.maxMemory || 20)
            if (chat.settings.linkedMemories && chat.settings.linkedMemories.length > 0) {
              const contextPromises = chat.settings.linkedMemories.map(async link => {
            if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                chat.settings.linkedWorldBookIds
                    const book = state.worldBooks.find(b => b.id === id);
                    return book ? `[${book.name}]: ${book.content}` : '';
            const { proxyUrl, apiKey, model } = state.apiConfig;
              apiKey,
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
          const myAvatar = characterChat.settings.myAvatar || defaultMyGroupAvatar;
                npcAvatarHtml = `<div class="avatar" style="border-radius: 6px; background-color: ${bgColor}; color: white; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: 500;">${npcNameInitial}</div>`;
                characterChat.settings.aiAvatar || defaultAvatar
                  characterChat.settings.myAvatar || defaultMyGroupAvatar
                  avatarHtml = `<div class="character-chat-avatar" style="background-color: ${bgColor}; color: white; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: 500;">${npcNameInitial}</div>`;
            loadMoreBtn.style.fontSize = '12px';
            const persona = chat.settings.aiPersona;
              .slice(-chat.settings.maxMemory || 20)
            if (chat.settings.linkedMemories && chat.settings.linkedMemories.length > 0) {
              const contextPromises = chat.settings.linkedMemories.map(async link => {
            if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                chat.settings.linkedWorldBookIds
                    const book = state.worldBooks.find(b => b.id === id);
                    return book ? `[${book.name}]: ${book.content}` : '';
            const { proxyUrl, apiKey, model } = state.apiConfig;
              apiKey,
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
          const isVisualMode = chat.settings.visualVideoCallEnabled;
          document.getElementById('inner-voice-avatar').src = chat.settings.aiAvatar || defaultAvatar;
          const frameUrl = chat.settings.aiAvatarFrame || '';
          const labelFormat = chat.settings.innerVoiceAdopterLabelFormat || '领养人: {{user}}';
          const userNickname = chat.settings.myNickname || '你';
          document.getElementById('inner-voice-adopter-avatar').src = chat.settings.myAvatar || defaultAvatar;
            const shouldHideBorder = chat.settings.innerVoiceHideHeaderBorder || false;
          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) {
			- “${ownerChar.name}”的人设是: ${ownerChar.settings.aiPersona}
              apiKey,
              state.apiConfig.temperature,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
			#phone-screen, .screen, #chat-list, #world-book-list, .list-container, .form-container, #chat-messages,
			#wallpaper-screen, #font-settings-screen, #api-settings-screen, #character-selection-screen,
			#world-book-screen, #world-book-editor-screen, #character-phone-inner-screen, #character-phone-page {
			#desktop-dock { background-color: rgba(55, 65, 81, 0.5); }
			.list-item, .chat-list-item-swipe-container:not(:last-child), .chat-group-container, .world-book-group-container { border-bottom-color: var(--border-color) !important; }
			.chat-group-header, .world-book-group-header { background-color: #1c1c1e; }
			#font-preview, #wallpaper-preview, .font-preset-slot { background-color: #1c1c1e !important; border-color: #38383a !important; }
          const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
          document.getElementById('chat-settings-modal').classList.remove('visible');
              const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
          const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
                senderAvatar = chat.settings.myAvatar;
                  senderAvatar = chat.settings.aiAvatar;
            groupsContainer.innerHTML = '<p style="color: #8a8a8a; font-size: 13px;">还没有创建任何好友分组哦。</p>';
              if (chat.settings && chat.settings.background) {
                chat.settings.background = ''; // 清空它
            stickers = chat.settings.stickerLibrary || [];
                    chat.settings.stickerLibrary.splice(sticker.originalIndex, 1);
              chat.settings.stickerLibrary = chat.settings.stickerLibrary.filter(s => !selectedCharStickers.has(s.url));
              chat.settings.stickerLibrary.push(...newStickers);
                chat.settings.stickerLibrary.push(...stickersToAdd);
          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) {
            let geminiConfig = toGeminiRequestData(model, apiKey, tarotMasterPrompt, messagesForApi, isGemini);
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
          if (!chat.settings.petAdopted) {
              chat.settings.petAdopted = true;
              chat.settings.pet = {
          currentPetData = JSON.parse(JSON.stringify(chat.settings.pet));
          if (!chat || !chat.settings.pet || chat.settings.pet.type === '无') {
          // console.log(`为宠物"${chat.settings.pet.name}"启动衰减计时器。`);
            const pet = currentChat.settings.pet;
          chat.settings.pet = newPetSettings;
            !chat.settings.petAdopted ||
            !chat.settings.pet ||
            !chat.settings.pet.display.show
          const pet = chat.settings.pet;
          petEl.style.fontSize = `${pet.display.size}px`;
          if (!chat || !chat.settings.petAdopted || !chat.settings.pet || chat.settings.pet.type === '无') {
          const pet = chat.settings.pet;
          const myNickname = chat.settings.myNickname || '我';
          chat.settings.pet = pet;
          if (!chat || !chat.settings.pet || chat.settings.pet.type === '无') {
          document.getElementById('pet-chat-title').textContent = `和“${chat.settings.pet.name}”的对话`;
          const pet = chat.settings.pet;
          const myAvatar = chat.settings.myAvatar || defaultAvatar;
              avatarSrc = chat.settings.aiAvatar || defaultAvatar;
                avatarHtml = `<div class="avatar" style="font-size: 28px; text-align: center;">${pet.image}</div>`;
          const pet = chat.settings.pet;
          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) {
              apiKey,
              state.apiConfig.temperature,
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
            if (chat && chat.settings.pet) {
              chat.settings.pet.display.top = petEl.style.top;
              chat.settings.pet.display.left = petEl.style.left;
          if (!chat || !chat.settings.summary || !chat.settings.summary.enabled) return;
          const summarySettings = chat.settings.summary;
          const summarySettings = chat.settings.summary;
          chat.settings.summary.lastSummaryIndex = chat.history.length - 1;
          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) {
          const summarySettings = chat.settings.summary;
                    ? chat.settings.myNickname || '我'
            const geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                    temperature: parseFloat(state.apiConfig.temperature) || 0.3,
          chat.settings.summary.lastSummaryIndex = newLastSummaryIndex; // 更新索引
          document.getElementById('chat-settings-modal').classList.remove('visible');
            if (chat.settings.summary) {
              chat.settings.summary.lastSummaryIndex = newLastSummaryIndex;
          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) {
              headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
                temperature: parseFloat(state.apiConfig.temperature) || 0.5,
              const summarySettings = chat.settings.summary;
          const iconGrid = document.getElementById('char-phone-icon-settings-grid');
            itemEl.className = 'icon-setting-item';
			            <span style="font-size: 13px;">${app.name}</span>
			            <button class="change-icon-btn" data-icon-id="${app.id}" style="padding: 4px 10px; font-size: 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer;">更换</button>
          const groupId = state.apiConfig.minimaxGroupId;
          const apiKey = state.apiConfig.minimaxApiKey;
          if (!groupId || !apiKey) {
          const provider = state.apiConfig.minimaxProvider || 'cn';
          const speechModel = state.apiConfig.minimaxSpeechModel || 'speech-01-turbo';
          const baseUrl = provider === 'cn' ? 'https://api.minimaxi.com' : 'https://api.minimax.io';
          const speed = chat.settings.speed ?? 1.0;
          const langBoost = chat.settings.language_boost; // 如果是null或undefined, 就让它是null/undefined
            voice_setting: {
                Authorization: `Bearer ${apiKey}`,
              // 遍历SillyTavern worldbook中的所有条目
          const settings = chat.settings;
            : (chat.settings.aiPersona || '') + (chat.settings.myPersona || '');
          if (settings.linkedWorldBookIds) {
            wbText = settings.linkedWorldBookIds
          const allStickers = [...(settings.stickerLibrary || []), ...(state.charStickers || [])];
          const memoryDepth = settings.maxMemory || 10;
          const settings = chat.settings;
            const myNickname = chat.settings.myNickname || '我';
            combinedText += `你是一个群聊AI... # 群成员列表及人设\n${membersList}\n# 用户的角色\n- **${myNickname}**: ${chat.settings.myPersona}`;
            combinedText += chat.settings.aiPersona || '';
            combinedText += chat.settings.myPersona || '';
          if (settings.linkedWorldBookIds && settings.linkedWorldBookIds.length > 0) {
            const linkedContents = settings.linkedWorldBookIds
              .map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
          const memoryDepth = settings.maxMemory || 10;
              document.getElementById('ls-settings-modal').classList.remove('visible');
            document.getElementById('ls-settings-modal').classList.remove('visible');
          if (!chat || chat.isGroup || !chat.settings.streak?.enabled) {
          const streak = chat.settings.streak;
            // 如果是用户，就修改 chat.settings 里的专属标志
            chat.settings.isUserAdmin = !chat.settings.isUserAdmin;
            targetNickname = chat.settings.myNickname || '我';
            isAdminNow = chat.settings.isUserAdmin;
          const myNickname = chat.settings.myNickname || '我';
          const isAdmin = chat.settings.isUserAdmin;
            targetNickname = chat.settings.myNickname || '我';
            oldTitle = chat.settings.myGroupTitle || '';
              chat.settings.myGroupTitle = trimmedTitle;
            const myNickname = chat.settings.myNickname || '我';
          const oldOwnerNickname = chat.settings.myNickname || '我';
          const announcement = chat.settings.groupAnnouncement || '暂无公告';
          const canEdit = chat.ownerId === 'user' || chat.settings.isUserAdmin;
          const currentContent = chat.settings.groupAnnouncement || '';
          chat.settings.groupAnnouncement = newContent;
          const myNickname = chat.settings.myNickname || '我';
          if (!chat || chat.isGroup || !chat.settings.streak?.enabled) {
          const streak = chat.settings.streak;
          const borderHidden = chat.settings.innerVoiceHideHeaderBorder || false;
          // 确保 chat.settings 存在
          if (!chat.settings) chat.settings = {};
          chat.settings.innerVoiceHideHeaderBorder = !(chat.settings.innerVoiceHideHeaderBorder || false);
            header.classList.toggle('no-border', chat.settings.innerVoiceHideHeaderBorder);
          await showCustomAlert('操作成功', `分割线已${chat.settings.innerVoiceHideHeaderBorder ? '隐藏' : '显示'}。`);
          const currentFormat = chat.settings.innerVoiceAdopterLabelFormat || '领养人: {{user}}';
            chat.settings.innerVoiceAdopterLabelFormat = newFormat.trim() || '领养人: {{user}}';
          if (!chat || !chat.settings.innerVoiceStyles) return;
          const styles = chat.settings.innerVoiceStyles;
          if (!chat || !chat.settings.innerVoiceStyles) return;
          const styles = chat.settings.innerVoiceStyles;
          chat.settings.innerVoiceStyles = newStyles;
            const { proxyUrl, apiKey, model } = state.apiConfig;
            let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` },
              id: 'studio',
              tables: ['studioScripts', 'studioHistory'],
                'fontPresets',
                'apiPresets',
              studio: {
                tables: ['studioScripts', 'studioHistory'],
                  'fontPresets',
                  'apiPresets',
                studio: '小剧场数据',
              apiConfigFromDB,
              apiPresetsFromDB,
              db.apiConfig.get('main'),
              db.apiPresets.toArray(),
            const transformedWorldBooks = worldBooksFromDB.map(book => {
              const newBookFor330 = { ...book };
                    keys: [book.name],
                    content: book.content,
              const settingsFor330 = {
                ...chat.settings,
                'ai-persona': chat.settings.aiPersona,
                'my-persona': chat.settings.myPersona,
                'ai-avatar': chat.settings.aiAvatar,
                'my-avatar': chat.settings.myAvatar,
              return { ...chat, settings: settingsFor330 };
              apiConfig: apiConfigFromDB ? [apiConfigFromDB] : [],
              apiPresets: apiPresetsFromDB,
              'apiConfig',
              'apiPresets',
              'fontPresets',
                data330.worldBooks.forEach(book_330 => {
                  if (Array.isArray(book_330.content)) {
                    book_330.content.forEach(entry => {
                        categoryId: book_330.categoryId || 0, // 继承原合集的分类ID
              if (data330.apiConfig?.[0]) await db.apiConfig.put(data330.apiConfig[0]);
                'apiPresets',
            'apiConfig',
            'apiPresets',
            'fontPresets',
                    'apiConfig',
          if (!chat || !chat.settings.streak) return 0;
          const streakDays = chat.settings.streak.currentDays || 0;
          document.getElementById('intimacy-streak-days').textContent = `${chat.settings.streak?.currentDays || 0} 天`;
          if (!chat.settings.selectedIntimacyBadge) {
            const isSelected = chat.settings.selectedIntimacyBadge === threshold.symbol;
              '<p style="text-align:center; color:#999; font-size:13px;">暂无已解锁的徽章</p>';
          chat.settings.selectedIntimacyBadge = symbol;
          const screen = document.getElementById('world-book-screen');
          const listEl = document.getElementById('world-book-list');
          const editBtn = document.getElementById('toggle-world-book-edit-mode-btn');
          const addBtn = document.getElementById('add-world-book-btn');
          const importBtn = document.getElementById('import-world-book-btn');
          const deleteBtn = document.getElementById('world-book-delete-selected-btn');
          const bookId = item.dataset.bookId;
          if (!bookId) return;
            if (selectedWorldBooks.has(bookId)) {
              selectedWorldBooks.delete(bookId);
              selectedWorldBooks.add(bookId);
            openWorldBookEditor(bookId);
          const deleteBtn = document.getElementById('world-book-delete-selected-btn');
          const countSpan = document.getElementById('world-book-delete-count');
            const booksToDelete = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
            const bookIdsToDelete = booksToDelete.map(book => book.id);
            if (bookIdsToDelete.length > 0) {
              await db.worldBooks.bulkDelete(bookIdsToDelete);
              state.worldBooks = state.worldBooks.filter(wb => !bookIdsToDelete.includes(wb.id));
            const booksToUpdate = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
            if (booksToUpdate.length > 0) {
              for (const book of booksToUpdate) {
                book.categoryId = null;
              await db.worldBooks.bulkPut(booksToUpdate);
              booksToUpdate.forEach(updatedBook => {
                const bookInState = state.worldBooks.find(wb => wb.id === updatedBook.id);
                if (bookInState) bookInState.categoryId = null;
        function createWorldBookGroup(groupName, books) {
          groupContainer.className = 'world-book-group-container';
			        <div class="world-book-group-header">
			        <div class="world-book-group-content"></div>
          const headerEl = groupContainer.querySelector('.world-book-group-header');
          const contentEl = groupContainer.querySelector('.world-book-group-content');
          books.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));
          books.forEach(book => {
            item.dataset.bookId = book.id;
            item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(
              book.content || '暂无内容...'
                `确定要删除《${book.name}》吗？此操作不可撤销。`,
                await db.worldBooks.delete(book.id);
                state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id);
                '<span style="background:#4CAF50; color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:5px;">语音</span>';
                '<span style="background:#FF9800; color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:5px;">图片</span>';
                '<span style="background:#E91E63; color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:5px;">转账</span>';
                '<span style="background:#2196F3; color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:5px;">外卖</span>';
          const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
          document.getElementById('aurora-save-book-btn').style.display = 'none';
            document.getElementById('aurora-save-book-btn').style.display = 'inline-block';
          showScreen('aurora-bookshelf-screen');
          const container = document.getElementById('bookshelf-container');
          const books = await db.auroraBooks.orderBy('addedAt').reverse().toArray();
          if (books.length === 0) {
              '<div class="bookshelf-row" style="justify-content:center; align-items:center; color:#8d6e63; font-size:14px;">书架空空如也...</div>';
          const booksPerRow = 6;
          for (let i = 0; i < books.length; i += booksPerRow) {
            const rowBooks = books.slice(i, i + booksPerRow);
            rowDiv.className = 'bookshelf-row';
            rowBooks.forEach(book => {
              const bookEl = document.createElement('div');
              const colorClass = `book-color-${Math.floor(Math.random() * 5) + 1}`;
              bookEl.className = `retro-book ${colorClass}`;
              bookEl.title = book.title; // 鼠标悬停显示全名
              bookEl.innerHTML = `<span class="book-spine-title">${book.title}</span>`;
              bookEl.addEventListener('click', () => loadBookFromShelf(book));
              addLongPressListener(bookEl, async () => {
                const confirmed = await showCustomConfirm('移除书籍', `要把《${book.title}》从书架上拿走吗？`, {
                  await db.auroraBooks.delete(book.id);
              rowDiv.appendChild(bookEl);
          if (books.length % booksPerRow !== 0 || books.length < 4) {
            emptyRow.className = 'bookshelf-row';
          document.getElementById('aurora-save-book-btn').style.display = 'none';
        function loadBookFromShelf(book) {
            title: book.title,
            textContent: book.content,
            currentBookId: book.id,
          const saveBtn = document.getElementById('aurora-save-book-btn');
          document.getElementById('aurora-bookshelf-screen').classList.remove('active'); // 退出书架
          statusTitle.textContent = `正在漫游:《${book.title}》`;
          document.getElementById('aurora-text-body').textContent = book.content;
            if (book.progress) {
              const targetScrollTop = Math.floor(scrollHeight * book.progress);
              console.log(`已恢复阅读进度: ${(book.progress * 100).toFixed(1)}%`);
        document.getElementById('open-aurora-bookshelf-btn').addEventListener('click', openAuroraBookshelf);
        document.getElementById('back-from-bookshelf').addEventListener('click', () => {
          document.getElementById('aurora-bookshelf-screen').classList.remove('active');
        document.getElementById('aurora-save-book-btn').addEventListener('click', saveCurrentNovelToShelf);
          let { githubToken, githubUsername, githubRepo, githubPath } = state.apiConfig;
            const singleObjects = ['apiConfig', 'globalSettings', 'musicLibrary', 'qzoneSettings'];
                if (data && task.name === 'apiConfig') {
                  data.apiKey = '';
          let { githubToken, githubUsername, githubRepo, githubPath } = state.apiConfig;
            const singleObjects = ['apiConfig', 'globalSettings', 'musicLibrary', 'qzoneSettings'];
              const metaUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${fileName}.meta`;
                  const partUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${partName}`;
                    const blobUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/git/blobs/${partJson.sha}`;
                const fileUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${fileName}`;
                  const blobUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/git/blobs/${json.sha}`;
                    if (task.name === 'apiConfig') {
                      if (!data.apiKey) data.apiKey = state.apiConfig.apiKey;
                      if (!data.githubToken) data.githubToken = state.apiConfig.githubToken;
          let { githubToken, githubUsername, githubRepo, githubPath } = state.apiConfig;
            const singleObjects = ['apiConfig', 'globalSettings', 'musicLibrary', 'qzoneSettings'];
              const apiUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${fileName}`;
                const res = await fetch(apiUrl, {
                // 处理大文件 Blob (如果是大文件 github api 会返回 sha 没 content)
                  const blobUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/git/blobs/${json.sha}`;
                  // 对于配置对象，如果是 apiConfig，保留当前的 Key 别被空值覆盖
                  if (targetStore === 'apiConfig') {
                    if (!dataJson.apiKey) dataJson.apiKey = state.apiConfig.apiKey;
                    if (!dataJson.githubToken) dataJson.githubToken = state.apiConfig.githubToken;
          applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // 清除预览区的自定义样式
            .classList.toggle('no-home-font-shadow', !!state.globalSettings.removeHomeFontShadow);
          if (state.globalSettings && state.globalSettings.fontUrl) {
            applyCustomFont(state.globalSettings.fontUrl);
            document.getElementById('chat-settings-btn').click();
          document.getElementById('chat-settings-modal').addEventListener('click', e => {
              document.getElementById('chat-settings-modal').classList.remove('visible');
            document.getElementById('chat-settings-btn').click();
			        <p id="copy-device-code-feedback" style="height: 15px; font-size: 12px; color: green;"></p>
            applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // 清除预览区的自定义样式
                settings: {
                  fontSize: 13,
                  authorAvatar: chat.settings.aiAvatar || defaultAvatar,
            if (chat && chat.isGroup && chat.settings.isUserMuted) {
              'remove-home-font-shadow-toggle',
          document.getElementById('save-api-settings-btn').addEventListener('click', async () => {
            const apiKey = document.getElementById('api-key').value.trim();
            state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim();
            state.apiConfig.apiKey = document.getElementById('api-key').value.trim();
            state.apiConfig.model = document.getElementById('model-select').value;
            state.apiConfig.temperature = parseFloat(document.getElementById('temperature-slider').value);
            state.apiConfig.minimaxGroupId = document.getElementById('minimax-group-id').value.trim();
            state.apiConfig.minimaxApiKey = document.getElementById('minimax-api-key').value.trim();
            state.apiConfig.minimaxProvider = document.getElementById('minimax-provider-select').value;
            state.apiConfig.minimaxSpeechModel = document.getElementById('minimax-speech-model-select').value;
            state.apiConfig.githubToken = document.getElementById('github-token').value.trim();
            state.apiConfig.githubUsername = document.getElementById('github-username').value.trim();
            state.apiConfig.githubRepo = document.getElementById('github-repo').value.trim();
            state.apiConfig.githubPath = document.getElementById('github-path').value.trim() || 'ephone_backup.json';
            state.apiConfig.githubAutoBackup = document.getElementById('github-auto-backup-switch').checked;
            state.apiConfig.githubBackupMode = document.getElementById('github-backup-mode').value;
            state.apiConfig.githubBackupInterval =
            await db.apiConfig.put(state.apiConfig);
            // 在 'save-api-settings-btn' 的 click 事件监听器内部
            // await db.apiConfig.put(state.apiConfig); 这行之后
          const ApiKeyInput = document.getElementById('api-key');
            const key = document.getElementById('api-key').value.trim();
                if (model.id === state.apiConfig.model) option.selected = true;
            const input = document.getElementById('novelai-api-key');
          document.getElementById('novelai-settings-btn').addEventListener('click', () => {
            document.getElementById('novelai-settings-modal').style.display = 'flex';
          document.getElementById('close-novelai-settings').addEventListener('click', () => {
            document.getElementById('novelai-settings-modal').style.display = 'none';
          document.getElementById('save-nai-settings-btn').addEventListener('click', () => {
            document.getElementById('novelai-settings-modal').style.display = 'none';
          document.getElementById('reset-nai-settings-btn').addEventListener('click', () => {
            const apiKey = document.getElementById('novelai-api-key').value.trim();
            if (!apiKey) {
            const naiSettings = chat.settings.naiSettings || {
            if (!chat.settings.naiSettings) {
              chat.settings.naiSettings = {
            chat.settings.naiSettings.characterPositivePrompt = document
            chat.settings.naiSettings.characterNegativePrompt = document
            console.log('   characterPositivePrompt:', chat.settings.naiSettings.characterPositivePrompt);
            console.log('   characterNegativePrompt:', chat.settings.naiSettings.characterNegativePrompt);
            console.log('   promptSource:', chat.settings.naiSettings.promptSource);
            const naiSettings = chat.settings.naiSettings || {
          document.getElementById('import-world-book-btn').addEventListener('click', async () => {
              document.getElementById('world-book-import-input').click(); // 直接打开文件选择器
			        <p id="copy-device-code-feedback" style="height: 15px; font-size: 12px; color: green;"></p>
              document.getElementById('world-book-import-input').click();
          document.getElementById('world-book-import-input').addEventListener('change', e => {
          document.getElementById('toggle-world-book-edit-mode-btn').addEventListener('click', toggleWorldBookEditMode);
          // 原来的 manage-world-book-categories-btn 按钮现在是编辑模式的切换按钮了
          document.getElementById('world-book-list').addEventListener('click', handleWorldBookListClick);
            .getElementById('world-book-delete-selected-btn')
          document.getElementById('add-world-book-btn').addEventListener('click', async () => {
          document.getElementById('save-world-book-btn').addEventListener('click', async () => {
            const book = state.worldBooks.find(wb => wb.id === editingWorldBookId);
            if (book) {
              const newName = document.getElementById('world-book-name-input').value.trim();
              book.name = newName;
              book.content = document.getElementById('world-book-content-input').value;
              const categoryId = document.getElementById('world-book-category-select').value;
              book.categoryId = categoryId ? parseInt(categoryId) : null;
              await db.worldBooks.put(book);
              document.getElementById('world-book-editor-title').textContent = newName;
              showScreen('world-book-screen');
                  const groupId = state.apiConfig.minimaxGroupId;
                  const apiKey = state.apiConfig.minimaxApiKey;
                  const voiceId = chat.settings.minimaxVoiceId;
                  if (groupId && apiKey && voiceId) {
          const chatSettingsModal = document.getElementById('chat-settings-modal');
          const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
            .getElementById('world-book-checkboxes-container')
          document.getElementById('chat-settings-btn').addEventListener('click', async () => {
            document.getElementById('streak-settings-section').style.display = isGroup ? 'none' : 'block';
              let htmlContent = '<div style="text-align: left; font-size: 13px;">';
                htmlContent += `<div style="color: #ff3b30; font-weight: bold; margin-bottom: 8px;">⚠️ 发现占用较大的消息 (Top ${outliers.length})</div>`;
                         style="display:flex; justify-content:space-between; align-items:center; padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 12px;">
                        <div style="color: #666; margin-left: 10px; font-family: monospace;">
                htmlContent += `<p style="font-size:11px; color:#aaa; margin-top:4px;">点击即可定位并高亮该消息，您可以选择删除它。</p>`;
            <div style="text-align:right; font-weight:bold; font-size:15px;">总计: ${total} 字符</div>
            const videoCallSettingsGroup = document.getElementById('video-call-settings-group');
            const summarySettings = chat.settings.summary || {};
              visualCallSwitch.checked = chat.settings.visualVideoCallEnabled || false;
                chat.settings.charVideoImage || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
                chat.settings.userVideoImage || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
              voiceAccessSwitch.checked = chat.settings.videoCallVoiceAccess || false;
            const offlineModeSettings = chat.settings.offlineMode || { enabled: false, presets: [] }; // 安全获取
            const naiCharacterSettingsGroup = document.getElementById('nai-character-settings-group');
              const naiSettings = chat.settings.naiSettings || {
            const groupNaiSettingsGroup = document.getElementById('group-nai-settings-group');
              const groupNaiSettings = chat.settings.naiSettings || {
            document.getElementById('my-persona').value = chat.settings.myPersona;
              chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
            document.getElementById('max-memory').value = chat.settings.maxMemory;
              const existingLink = chat.settings.linkedMemories.find(link => link.chatId === otherChat.id);
                ? otherChat.settings.groupAvatar || defaultGroupAvatar
                : otherChat.settings.aiAvatar || defaultAvatar;
            document.getElementById('link-memory-depth-input').value = chat.settings.linkMemoryDepth || 5;
            const isTimeEnabled = chat.settings.timePerceptionEnabled ?? true;
            customTimeInput.value = chat.settings.customTime || '';
            if (chat.settings.background) {
              bgPreview.src = chat.settings.background;
              document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
              document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
              const groupIntervalSettings = document.getElementById('group-background-interval-settings');
              const bgSettings = chat.settings.backgroundActivity || { enabled: false, interval: 120 };
              document.getElementById('ai-persona').value = chat.settings.aiPersona;
              document.getElementById('weibo-profession-input').value = chat.settings.weiboProfession || '';
              document.getElementById('weibo-instruction-input').value = chat.settings.weiboInstruction || '';
              document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
              document.getElementById('minimax-voice-id-input').value = chat.settings.minimaxVoiceId || '';
                langBoostSelect.value = chat.settings.language_boost || '';
                const speed = chat.settings.speed ?? 1.0; // 使用 ?? 确保即使值为0也能正确处理
              coupleAvatarToggle.checked = chat.settings.isCoupleAvatar || false;
              coupleAvatarDescInput.value = chat.settings.coupleAvatarDescription || '';
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
            const linkedIds = new Set(chat.settings.linkedWorldBookIds || []);
            const books = state.worldBooks;
            const hasUncategorized = books.some(book => !book.categoryId);
            const booksByCategoryId = books.reduce((acc, book) => {
              const categoryId = book.categoryId || 'uncategorized';
              acc[categoryId].push(book);
              const booksInCategory = booksByCategoryId[category.id] || [];
              if (booksInCategory.length > 0) {
                const allInCategoryChecked = booksInCategory.every(book => linkedIds.has(book.id));
                const bookContainer = document.createElement('div');
                bookContainer.className = 'wb-book-container';
                bookContainer.dataset.containerFor = category.id;
                booksInCategory.forEach(book => {
                  const isChecked = linkedIds.has(book.id);
                  label.innerHTML = `<input type="checkbox" class="wb-book-checkbox" value="${
                    book.id
                  }" data-parent-category="${category.id}" ${isChecked ? 'checked' : ''}> <span class="wb-book-name">${
                    book.name
                  bookContainer.appendChild(label);
                bookContainer.classList.add('collapsed');
                worldBookCheckboxesContainer.appendChild(bookContainer);
              `input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`,
            const fontSizeSlider = document.getElementById('font-size-slider');
            fontSizeSlider.value = chat.settings.fontSize || 13;
            document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
            const streakSettings = chat.settings.streak || { enabled: false, initialDays: 0, extinguishThreshold: 1 };
            document.getElementById('streak-font-color-picker').value = streakSettings.fontColor || '#ff6f00'; // 默认橙色
            customCssInput.value = chat.settings.customCss || '';
            document.getElementById('chat-settings-modal').classList.add('visible');
            const container = document.getElementById('group-members-settings');
            document.getElementById('member-settings-modal').classList.add('visible');
          document.getElementById('cancel-member-settings-btn').addEventListener('click', () => {
            document.getElementById('member-settings-modal').classList.remove('visible');
          document.getElementById('save-member-settings-btn').addEventListener('click', () => {
            document.getElementById('member-settings-modal').classList.remove('visible');
          document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => {
          document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
            chat.settings.linkMemoryDepth = memoryDepth; // 独立保存记忆条数设置
            chat.settings.linkedMemories = Array.from(linkedMemoryCheckboxes).map(checkbox => ({
            chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';
            chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
            chat.settings.customCss = document.getElementById('custom-css-input').value.trim();
            chat.settings.myPersona = document.getElementById('my-persona').value;
            chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
              '#world-book-checkboxes-container input.wb-book-checkbox:checked',
            chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value);
              chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
              chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
              const lastTimestamp = chat.settings.backgroundActivity
                ? chat.settings.backgroundActivity.lastActivityTimestamp
              chat.settings.backgroundActivity = {
              chat.settings.aiPersona = document.getElementById('ai-persona').value;
              chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
              chat.settings.minimaxVoiceId = document.getElementById('minimax-voice-id-input').value.trim();
              chat.settings.language_boost = langBoost ? langBoost : null; // 如果选择"无"(value为空),则保存为null
              chat.settings.speed = parseFloat(document.getElementById('minimax-speed-slider').value);
              chat.settings.isCoupleAvatar = document.getElementById('couple-avatar-toggle').checked;
              chat.settings.coupleAvatarDescription = document.getElementById('couple-avatar-description').value.trim();
              chat.settings.weiboProfession = document.getElementById('weibo-profession-input').value.trim();
              chat.settings.weiboInstruction = document.getElementById('weibo-instruction-input').value.trim();
              chat.settings.visualVideoCallEnabled = document.getElementById('visual-video-call-switch').checked;
              chat.settings.charVideoImage = document.getElementById('char-video-image-preview').src;
              chat.settings.userVideoImage = document.getElementById('user-video-image-preview').src;
              chat.settings.videoCallVoiceAccess = document.getElementById('video-call-voice-access-switch').checked;
                if (!chat.settings.naiSettings) {
                  chat.settings.naiSettings = {};
                chat.settings.naiSettings.promptSource = promptSourceRadio ? promptSourceRadio.value : 'system';
                console.log('💾 保存NAI设置 - promptSource:', chat.settings.naiSettings.promptSource);
                  chat.settings.naiSettings.characterPositivePrompt,
                  chat.settings.naiSettings.characterNegativePrompt,
            chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
            chat.settings.timePerceptionEnabled = document.getElementById('time-perception-toggle').checked;
            chat.settings.customTime = document.getElementById('custom-time-input').value;
            if (!chat.settings.offlineMode) chat.settings.offlineMode = {}; // 初始化
            chat.settings.offlineMode.enabled = document.getElementById('offline-mode-toggle').checked;
            chat.settings.offlineMode.prompt = document.getElementById('offline-prompt-input').value.trim();
            chat.settings.offlineMode.style = document.getElementById('offline-style-input').value.trim();
            chat.settings.offlineMode.wordCount =
            chat.settings.offlineMode.enableNovelAI = document.getElementById('offline-novelai-toggle').checked;
            if (!chat.settings.summary) chat.settings.summary = {}; // 初始化
            chat.settings.summary.enabled = document.getElementById('summary-toggle').checked;
            chat.settings.summary.mode = document.querySelector('input[name="summary-mode"]:checked').value;
            chat.settings.summary.count = parseInt(document.getElementById('summary-count-input').value) || 20;
            chat.settings.summary.prompt = document.getElementById('summary-prompt-input').value.trim();
            // 在 'save-chat-settings-btn' 的 click 事件监听器内部...
            const oldStreak = chat.settings.streak || {}; // 安全地获取旧设置
              chat.settings.streak = {
                fontColor: document.getElementById('streak-font-color-picker').value,
              chat.settings.streak = {
                fontColor: '#ff6f00',
            applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
              state.chats[state.activeChatId].settings.background = base64;
              state.chats[state.activeChatId].settings.background = '';
            const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
          document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);
                    authorToSearch = chat.isGroup ? chat.settings.myNickname || '我' : '我';
          const fontSizeSlider = document.getElementById('font-size-slider');
          fontSizeSlider.addEventListener('input', () => {
            document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
            const chatSettingsBtn = document.getElementById('chat-settings-btn');
            if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
            document.getElementById('chat-settings-modal').classList.remove('visible');
            document.getElementById('chat-settings-btn').click();
              document.getElementById('chat-settings-modal').classList.remove('visible');
          document.getElementById('icon-settings-grid').addEventListener('click', async e => {
              const item = e.target.closest('.icon-setting-item');
              senderName: sourceChat.isGroup ? sourceChat.settings.myNickname || '我' : '我',
            document.getElementById('world-book-category-manager-modal').classList.remove('visible');
          document.getElementById('chat-settings-modal').addEventListener('click', e => {
          document.getElementById('member-settings-modal').addEventListener('click', e => {
            .getElementById('cancel-frame-settings-btn')
          document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);
                const bookContainer = worldBookCheckboxesContainer.querySelector(
                  `.wb-book-container[data-container-for="${categoryId}"]`,
                if (bookContainer) {
                  bookContainer.classList.toggle('collapsed');
              const bookCheckboxes = worldBookCheckboxesContainer.querySelectorAll(
                `input.wb-book-checkbox[data-parent-category="${categoryId}"]`,
              bookCheckboxes.forEach(cb => (cb.checked = isChecked));
            if (target.classList.contains('wb-book-checkbox')) {
                  `input.wb-book-checkbox[data-parent-category="${categoryId}"]`,
          document.getElementById('api-preset-select').addEventListener('change', handleApiPresetSelectChange);
          document.getElementById('manage-api-presets-btn').addEventListener('click', openApiPresetManager);
          document.getElementById('lyrics-settings-btn').addEventListener('click', e => {
            document.getElementById('lyrics-settings-modal').classList.add('visible');
          document.getElementById('close-lyrics-settings-btn').addEventListener('click', async () => {
            document.getElementById('lyrics-settings-modal').classList.remove('visible');
          document.getElementById('reset-lyrics-settings-btn').addEventListener('click', () => {
            lyricsBarSettings = { fontSize: 14, bgOpacity: 0, fontColor: '#FFFFFF', showOnClose: true };
          document.getElementById('lyrics-font-size-slider').addEventListener('input', e => {
            lyricsBarSettings.fontSize = e.target.value;
          document.getElementById('lyrics-font-color-picker').addEventListener('input', e => {
            lyricsBarSettings.fontColor = e.target.value;
          document.getElementById('chat-settings-modal').addEventListener('click', e => {
              document.getElementById('chat-settings-modal').classList.remove('visible');
            document.getElementById('chat-settings-btn').click();
          document.getElementById('remove-home-font-shadow-toggle').addEventListener('change', e => {
            document.getElementById('phone-screen').classList.toggle('no-home-font-shadow', e.target.checked);
              chat.settings.petAdopted = false; // 关闭领养状态
              delete chat.settings.pet; // 删除宠物数据对象
            document.getElementById('chat-settings-btn').click();
          document.getElementById('chat-settings-modal').addEventListener('click', e => {
              document.getElementById('chat-settings-modal').classList.remove('visible');
            document.getElementById('chat-settings-btn').click();
          // “kk查岗”功能事件监听器
          document.getElementById('kk-checkin-app-icon').addEventListener('click', openKkCheckin);
          document.getElementById('kk-char-selection-list').addEventListener('click', e => {
            .getElementById('kk-back-from-house-view')
            .addEventListener('click', () => showScreen('kk-char-selection-screen'));
            .getElementById('kk-back-from-area-view')
            .addEventListener('click', () => showScreen('kk-house-view-screen'));
            .getElementById('close-kk-computer-modal')
            .addEventListener('click', () => document.getElementById('kk-computer-modal').classList.remove('visible'));
              document.getElementById('kk-file-explorer-modal').classList.remove('visible'),
          document.getElementById('kk-reset-search-btn').addEventListener('click', handleResetKkHouse);
          document.getElementById('kk-continue-search-btn').addEventListener('click', handleContinueKkSearch);
            .getElementById('close-kk-computer-modal')
            .addEventListener('click', () => document.getElementById('kk-computer-modal').classList.remove('visible'));
          document.getElementById('kk-computer-desktop').addEventListener('click', e => {
            const icon = e.target.closest('.kk-desktop-icon');
              case 'kk-browser-icon':
              case 'kk-movies-icon':
              case 'kk-files-icon':
              case 'kk-secret-folder-icon':
              case 'kk-steam-icon':
          document.getElementById('close-kk-file-viewer-btn').addEventListener('click', closeFileViewer);
          document.getElementById('kk-file-viewer-modal').addEventListener('click', e => {
            if (e.target.id === 'kk-file-viewer-modal') {
              document.getElementById('kk-file-explorer-modal').classList.remove('visible'),
          document.getElementById('kk-file-list').addEventListener('click', e => {
            const fileItem = e.target.closest('.kk-file-item');
          document.getElementById('close-kk-file-viewer-btn').addEventListener('click', closeFileViewer);
          document.getElementById('kk-file-viewer-modal').addEventListener('click', e => {
            if (e.target.id === 'kk-file-viewer-modal') {
          document.getElementById('close-kk-steam-modal-btn').addEventListener('click', () => {
            document.getElementById('kk-steam-modal').classList.remove('visible');
          document.getElementById('kk-generate-more-games-btn').addEventListener('click', generateMoreSteamGames);
          document.getElementById('kk-steam-games-list').addEventListener('click', async e => {
          /* --- kk查岗-监控功能事件监听器 --- */
          document.getElementById('kk-house-view-screen').addEventListener('click', e => {
            if (e.target.closest('#kk-surveillance-icon')) {
          document.getElementById('kk-back-from-monitor').addEventListener('click', () => {
            showScreen('kk-house-view-screen');
          document.getElementById('kk-refresh-monitor-btn').addEventListener('click', async () => {
          document.getElementById('kk-monitor-grid').addEventListener('click', e => {
            const monitorItem = e.target.closest('.kk-monitor-item');
          { id: 'frame_14', url: 'https://i.postimg.cc/xCqqKGRN/IMG-6929.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/VkKjzYTK/IMB-f4kk-CT.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/gkk7s0vD/IMG-6984.gif', name: '14' },
            url: 'https://i.postimg.cc/764qqSGc/NR8AVj-Vi-Q2d-Be-E1EVTBPVEE1Tk-Rn-Ml-FNVURh-VE1ub-Gp-BIQUAc-XVu-Z3o.gif',
			            font-size: 14px;
    <input type="file" id="world-book-import-input" accept=".json, .jsonl" style="display: none" />
function searchTencentMusic(name) {
          try {
            name = name.replace(/\s/g, '');
            const result = await Http_Get(`https://api.vkeys.cn/v2/music/tencent?word=${encodeURIComponent(name)}
function getLyricsForSong(songId, source) {
          const url =
            source === 'netease'
              ? `https://api.vkeys.cn/v2/music/netease/lyric?id=${songId}
function loadAllFontPresetsOnStartup() {
          console.log('正在预加载所有字体预设...');
          const presets = await db.fontPresets.toArray();
          if (presets && presets.length > 0) {
            presets.forEach(preset => {
              // 我们复用已有的 loadFontForPreview 函数来加载每个字体
              loadFontForPreview(preset);
            }
function renderFontPresets() {
          const container = document.getElementById('font-preset-container');
          container.innerHTML = ''; // 清空旧内容

          // 1. 从数据库读取所有已保存的预设，并确保它是一个数组
          const presets = (await db.fontPresets.toArray()) || [];

          // 我们不再依赖 presets 的长度来循环，而是无条件地循环10次，创建10个卡槽。
          for (let i = 0; i < 10; i++) {
            const slot = document.createElement('div');
            slot.className = 'font-preset-slot';

            // 3. 在循环内部，再判断当前索引 i 是否在已保存的 presets 数组中有对应的数据。
            const preset = presets[i];

            if (preset) {
              // 如果这个卡槽有数据，就渲染成“已填充”的样式
              slot.innerHTML = `
			                <div class="font-preview-text" data-preset-id="${preset.id}
function loadFontForPreview(preset) {
          const styleId = `font-style-${preset.id}
function handleUploadFontLocal(slotIndex) {
          const input = document.getElementById('font-preset-local-upload');
          input.onchange = async e => {
            const file = e.target.files[0];
            if (!file) return;

            const name = await showCustomPrompt('字体命名', '请为这个字体起个名字', file.name.replace(/\.[^/.]+$/, ''));
            if (!name || !name.trim()) {
              if (name !== null) alert('名字不能为空！');
              return;
            }
function saveFontPreset(slotIndex, name, url) {
          try {
            const presets = await db.fontPresets.toArray();
            const newPreset = { id: 'font_' + Date.now(), name, url }
function deleteFontPreset(presetId) {
          const preset = await db.fontPresets.get(presetId);
          if (!preset) return;
          const confirmed = await showCustomConfirm('确认删除', `确定要删除字体 "${preset.name}
function applyFontPreset(presetId) {
          const preset = await db.fontPresets.get(presetId);
          if (preset) {
            // 调用你已有的全局字体应用函数
            applyCustomFont(preset.url, false);
            // 保存到全局设置
            state.globalSettings.fontUrl = preset.url;
            await db.globalSettings.put(state.globalSettings);
            alert(`已将全局字体更换为 "${preset.name}
function renderQzoneScreen() {
          if (state && state.qzoneSettings) {
            const settings = state.qzoneSettings;
            document.getElementById('qzone-nickname').textContent = settings.nickname;
            document.getElementById('qzone-avatar-img').src = settings.avatar;
            document.getElementById('qzone-banner-img').src = settings.banner;
          }
function uploadSingleFile(user, repo, path, token, contentBase64, isAuto) {
          const apiUrl = `https://api.github.com/repos/${user}
function applyCustomFont(fontUrl, isPreviewOnly = false) {
          if (!fontUrl) {
            // 如果没有提供字体链接（比如恢复默认），就清空样式
            dynamicFontStyle.innerHTML = '';
            document.getElementById('font-preview').style.fontFamily = '';
            return;
          }
function resetToDefaultFont() {
          // 1. 清除全局字体样式
          dynamicFontStyle.innerHTML = '';

          // 2. 更新并保存设置
          state.globalSettings.fontUrl = '';
          await db.globalSettings.put(state.globalSettings);

          // 3. 明确地将全局预览区的字体也恢复为默认
          const globalPreview = document.getElementById('font-preview');
          globalPreview.style.fontFamily = ''; // 移除内联样式

          // 4. 应用一下空的字体设置，确保所有地方都恢复
          applyCustomFont('', true);

          alert('已恢复默认字体。');
        }
function loadAllDataFromDB() {
          const [
            chatsArr,
            apiConfig,
            globalSettings,
            userStickers,
            charStickers,
            worldBooks,
            musicLib,
            personaPresets,
            qzoneSettings,
            initialFavorites,
            apiPresets,
            bubbleStylePresets,
            datingScenes, // <--- 在这里新增
            localUserStickerCategories,
            offlinePresetsFromDB,
          ] = await Promise.all([
            db.chats.toArray(),
            db.apiConfig.get('main'),
            db.globalSettings.get('main'),
            db.userStickers.toArray(),
            db.charStickers.toArray(),
            db.worldBooks.toArray(),
            db.musicLibrary.get('main'),
            db.personaPresets.toArray(),
            db.qzoneSettings.get('main'),
            db.favorites.orderBy('timestamp').reverse().toArray(),
            db.apiPresets.toArray(),
            db.bubbleStylePresets.toArray(),
            db.datingScenes.toArray(), // <--- 在这里新增
            db.userStickerCategories.toArray(),
            db.offlinePresets.toArray(),
          ]);
          state.offlinePresets = offlinePresetsFromDB || [];
          state.chats = chatsArr.reduce((acc, chat) => {
            if (!chat.checkpoints) {
              chat.checkpoints = [];
            }
function showNotification(chatId, messageContent) {
          playNotificationSound();
          clearTimeout(notificationTimeout);
          const chat = state.chats[chatId];
          if (!chat) return;
          const bar = document.getElementById('notification-bar');
          document.getElementById('notification-avatar').src =
            chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar;
          document.getElementById('notification-content').querySelector('.name').textContent = chat.name;
          document.getElementById('notification-content').querySelector('.message').textContent = messageContent;
          const newBar = bar.cloneNode(true);
          bar.parentNode.replaceChild(newBar, bar);
          newBar.addEventListener('click', () => {
            openChat(chatId);
            newBar.classList.remove('visible');
          }
function deleteExpiredSearchedSongs() {
          await showCustomAlert('请稍候...', '正在检查播放列表中所有在线歌曲的有效性...');

          // 1. 不再寻找 isTemporary 标签
          // 而是直接找出所有 src 链接来自于 API 服务器的歌曲。
          // 这是一个绝对可靠的识别方法，无论它有没有被正确保存。
          const songsToCheck = musicState.playlist.filter(track => track.src && track.src.includes('api.vkeys.cn'));

          if (songsToCheck.length === 0) {
            await showCustomAlert('提示', '播放列表中没有需要检查的在线歌曲。');
            return;
          }
function loadNovelAISettings() {
          const settings = getNovelAISettings();
          document.getElementById('nai-resolution').value = settings.resolution;
          document.getElementById('nai-steps').value = settings.steps;
          document.getElementById('nai-cfg-scale').value = settings.cfg_scale;
          document.getElementById('nai-sampler').value = settings.sampler;
          document.getElementById('nai-seed').value = settings.seed;
          document.getElementById('nai-uc-preset').value = settings.uc_preset;
          document.getElementById('nai-quality-toggle').checked = settings.quality_toggle;
          document.getElementById('nai-smea').checked = settings.smea;
          document.getElementById('nai-smea-dyn').checked = settings.smea_dyn;
          document.getElementById('nai-default-positive').value = settings.default_positive;
          document.getElementById('nai-default-negative').value = settings.default_negative;
          document.getElementById('nai-cors-proxy').value = settings.cors_proxy;
          document.getElementById('nai-custom-proxy-url').value = settings.custom_proxy_url || '';

          // 显示/隐藏自定义代理输入框
          const customProxyGroup = document.getElementById('nai-custom-proxy-group');
          customProxyGroup.style.display = settings.cors_proxy === 'custom' ? 'block' : 'none';
        }
function saveNovelAISettings() {
          // 保存API Key和模型等基础配置
          const novelaiEnabled = document.getElementById('novelai-switch').checked;
          const novelaiModel = document.getElementById('novelai-model').value;
          const novelaiApiKey = document.getElementById('novelai-api-key').value.trim();

          localStorage.setItem('novelai-enabled', novelaiEnabled);
          localStorage.setItem('novelai-model', novelaiModel);
          localStorage.setItem('novelai-api-key', novelaiApiKey);

          // 保存高级参数配置
          const settings = {
            resolution: document.getElementById('nai-resolution').value,
            steps: parseInt(document.getElementById('nai-steps').value),
            cfg_scale: parseFloat(document.getElementById('nai-cfg-scale').value),
            sampler: document.getElementById('nai-sampler').value,
            seed: parseInt(document.getElementById('nai-seed').value),
            uc_preset: parseInt(document.getElementById('nai-uc-preset').value),
            quality_toggle: document.getElementById('nai-quality-toggle').checked,
            smea: document.getElementById('nai-smea').checked,
            smea_dyn: document.getElementById('nai-smea-dyn').checked,
            default_positive: document.getElementById('nai-default-positive').value,
            default_negative: document.getElementById('nai-default-negative').value,
            cors_proxy: document.getElementById('nai-cors-proxy').value,
            custom_proxy_url: document.getElementById('nai-custom-proxy-url').value,
          }
function resetNovelAISettings() {
          localStorage.removeItem('novelai-settings');
          loadNovelAISettings();
          alert('已恢复默认设置！');
        }
function generateNovelAIImageForCharacter(chatId, customPrompt = '') {
          const apiKey = document.getElementById('novelai-api-key').value.trim();
          const model = document.getElementById('novelai-model').value;

          if (!apiKey) {
            throw new Error('请先配置NovelAI API Key！');
          }
function generateNovelAIImage() {
          const apiKey = document.getElementById('novelai-api-key').value.trim();
          const model = document.getElementById('novelai-model').value;
          const prompt = document.getElementById('nai-test-prompt').value.trim();

          if (!apiKey) {
            alert('请先配置NovelAI API Key！');
            return;
          }
function renderApiSettings() {
          // 1. 更新 API 相关的输入框
          document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || '';
          document.getElementById('api-key').value = state.apiConfig.apiKey || '';

          // --- Minimax 设置 ---
          document.getElementById('minimax-group-id').value = state.apiConfig.minimaxGroupId || '';
          document.getElementById('minimax-api-key').value = state.apiConfig.minimaxApiKey || '';
          document.getElementById('minimax-provider-select').value = state.apiConfig.minimaxProvider || 'cn';

          // 2：Minimax 语音模型下拉框回显
          const speechModelSelect = document.getElementById('minimax-speech-model-select');
          if (speechModelSelect) {
            // 获取保存的模型，如果没有则默认为 speech-01-turbo
            const savedSpeechModel = state.apiConfig.minimaxSpeechModel || 'speech-01-turbo';

            // 检查下拉框里有没有这个选项
            let optionExists = Array.from(speechModelSelect.options).some(opt => opt.value === savedSpeechModel);

            // 如果没有（比如刚刷新完页面），就手动创建一个选项加进去
            if (!optionExists && savedSpeechModel) {
              const option = document.createElement('option');
              option.value = savedSpeechModel;
              option.textContent = savedSpeechModel;
              speechModelSelect.appendChild(option);
            }
function renderWorldBookScreen() {
          const listEl = document.getElementById('world-book-list');
          listEl.innerHTML = '';

          // 1. 同时获取所有书籍和所有分类
          const [books, categories] = await Promise.all([
            db.worldBooks.toArray(),
            db.worldBookCategories.orderBy('name').toArray(),
          ]);

          state.worldBooks = books; // 确保内存中的数据是同步的

          if (books.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">点击右上角 "+" 创建你的第一本世界书</p>';
            return;
          }
function createWorldBookGroup(groupName, books) {
          const groupContainer = document.createElement('div');
          groupContainer.className = 'world-book-group-container';

          groupContainer.innerHTML = `
			        <div class="world-book-group-header">
			            <span class="arrow">▼</span>
			            <span class="group-name">${groupName}
function openWorldBookEditor(bookId) {
          editingWorldBookId = bookId;
          const [book, categories] = await Promise.all([db.worldBooks.get(bookId), db.worldBookCategories.toArray()]);
          if (!book) return;

          document.getElementById('world-book-editor-title').textContent = book.name;
          document.getElementById('world-book-name-input').value = book.name;
          document.getElementById('world-book-content-input').value = book.content;

          // 填充分类下拉菜单
          const selectEl = document.getElementById('world-book-category-select');
          selectEl.innerHTML = '<option value="">-- 未分类 --</option>'; // 默认选项
          categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            if (book.categoryId === cat.id) {
              option.selected = true; // 选中当前分类
            }
function formatMessageForContext(msg, chat) {
          let senderName = '';
          if (msg.role === 'user') {
            senderName = chat.isGroup ? chat.settings.myNickname || '我' : '我';
          }
function updatePlayerUI() {
          updateListenTogetherIcon(musicState.activeChatId);
          updateElapsedTimeDisplay();
          const titleEl = document.getElementById('music-player-song-title');
          const artistEl = document.getElementById('music-player-artist');
          const playPauseBtn = document.getElementById('music-play-pause-btn');
          const chat = state.chats[musicState.activeChatId];
          const charAvatarEl = document.getElementById('music-char-avatar');
          const userAvatarEl = document.getElementById('music-user-avatar');
          const albumCoverEl = document.getElementById('music-album-cover');
          const avatarsContainer = document.getElementById('music-avatars-container');
          const displayArea = document.getElementById('music-display-area');

          // 1. 判断是群聊还是单聊，并设置正确的头像
          if (chat) {
            // 如果是群聊
            if (chat.isGroup) {
              // 左边的头像就用群头像
              charAvatarEl.src = chat.settings.groupAvatar || defaultGroupAvatar;
            }
function triggerInactiveAiAction(chatId) {
          const chat = state.chats[chatId];
          if (!chat) return;

          const { proxyUrl, apiKey, model }
function updateSettingsPreview() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          const previewArea = document.getElementById('settings-preview-area');
          if (!previewArea) return;

          // 1. 获取当前设置的值
          const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
          const fontSize = document.getElementById('font-size-slider').value;
          const customCss = document.getElementById('custom-css-input').value;
          const background = chat.settings.background; // 直接获取背景设置

          // 2. 更新预览区的基本样式
          previewArea.dataset.theme = selectedTheme;
          previewArea.style.setProperty('--chat-font-size', `${fontSize}
function parseEditedContent(text) {
          const trimmedText = text.trim();
          // 1. 优先检查是否是 [sticker:名字] 格式
          const stickerNameMatch = trimmedText.match(/^\[sticker:(.+?)\]$/i);
          if (stickerNameMatch) {
            const name = stickerNameMatch[1];
            // 尝试去所有表情库里找回这个名字对应的URL
            const allStickers = [...(state.userStickers || []), ...(state.charStickers || [])];
            // 尝试获取当前聊天对象的专属表情(如果有)
            if (window.state && window.state.activeChatId && window.state.chats[window.state.activeChatId]) {
              const currentChat = window.state.chats[window.state.activeChatId];
              if (currentChat.settings.stickerLibrary) {
                allStickers.push(...currentChat.settings.stickerLibrary);
              }
function renderContactPicker() {
          const listEl = document.getElementById('contact-picker-list');
          listEl.innerHTML = '';
          selectedContacts.clear(); // 清空上次的选择

          const allAvailablePeople = [];
          // 1. 添加主要角色
          Object.values(state.chats)
            .filter(c => !c.isGroup)
            .forEach(c => {
              allAvailablePeople.push({
                id: c.id,
                name: c.name,
                avatar: c.settings.aiAvatar || defaultAvatar,
                isNpc: false, // 标记为非NPC
                type: '角色',
              }
function createMemberManagementItem(member, chat) {
          const item = document.createElement('div');
          item.className = 'member-management-item';

          // --- 权限判断 ---
          const isCurrentUserOwner = chat.ownerId === 'user';
          const isCurrentUserAdmin = chat.settings.isUserAdmin;
          const isThisMemberOwner = member.id === chat.ownerId;
          const isThisMemberAdmin = (member.id === 'user' && chat.settings.isUserAdmin) || member.isAdmin;

          // 权限计算：我能对TA做什么？
          const canManageAdmin = isCurrentUserOwner && !isThisMemberOwner; // 只有群主能设置/取消管理员
          const canManageTitle = isCurrentUserOwner || isCurrentUserAdmin; // 管理员和群主都能设置头衔
          const canKick =
            (isCurrentUserOwner && member.id !== 'user') ||
            (isCurrentUserAdmin && !isThisMemberOwner && !isThisMemberAdmin && member.id !== 'user');
          const canMute =
            (isCurrentUserOwner && member.id !== 'user') ||
            (isCurrentUserAdmin && !isThisMemberOwner && !isThisMemberAdmin && member.id !== 'user');

          // --- 标签显示 ---
          let roleTag = '';
          if (isThisMemberOwner) {
            roleTag = '<span class="role-tag owner">群主</span>';
          }
function handleMuteMember(memberId) {
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.isGroup) return;

          // --- 权限检查 (和之前保持一致) ---
          const isOwner = chat.ownerId === 'user';
          const isAdmin = chat.settings.isUserAdmin;
          let targetMember, targetIsOwner, targetIsAdmin;

          // 判断操作目标是普通成员还是用户自己
          if (memberId === 'user') {
            targetMember = { id: 'user', ...chat.settings }
function handleUserUnmute() {
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.settings.isUserMuted) return;

          const confirmed = await showCustomConfirm('解除禁言', '确定要为自己解除禁言吗？');
          if (confirmed) {
            chat.settings.isUserMuted = false;
            await db.chats.put(chat);

            await logSystemMessage(chat.id, `“${chat.settings.myNickname || '我'}
function handleSetUserNickname() {
          const chat = state.chats[state.activeChatId];
          const oldNickname = chat.settings.myNickname || '我';

          const newNickname = await showCustomPrompt('修改我的群昵称', '请输入新的昵称', oldNickname);
          if (newNickname !== null && newNickname.trim()) {
            chat.settings.myNickname = newNickname.trim();
            await db.chats.put(chat);

            // 发送一条系统消息通知群友
            await logSystemMessage(chat.id, `“${oldNickname}
function handleSetUserTitle() {
          const chat = state.chats[state.activeChatId];
          const oldTitle = chat.settings.myGroupTitle || '';

          const newTitle = await showCustomPrompt('修改我的群头衔', '留空则为取消头衔', oldTitle);
          if (newTitle !== null) {
            chat.settings.myGroupTitle = newTitle.trim();
            await db.chats.put(chat);

            // 调用你已有的函数来发送系统通知
            const myNickname = chat.settings.myNickname || '我';
            await logTitleChange(chat.id, myNickname, myNickname, newTitle.trim());

            renderMemberManagementList();
          }
function removeMemberFromGroup(memberId) {
          const chat = state.chats[state.activeChatId];
          const isOwner = chat.ownerId === 'user';
          const isAdmin = chat.settings.isUserAdmin;
          const memberToRemove = chat.members.find(m => m.id === memberId);

          // 权限检查
          if (!isOwner && !(isAdmin && !memberToRemove.isAdmin && memberToRemove.id !== chat.ownerId)) {
            alert('你没有权限移出该成员！');
            return;
          }
function openContactPickerForAddMember() {
          selectedContacts.clear();

          // 绑定正确的“添加成员”函数
          const confirmBtn = document.getElementById('confirm-contact-picker-btn');
          const newConfirmBtn = confirmBtn.cloneNode(true);
          confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
          newConfirmBtn.addEventListener('click', handleAddMembersToGroup);

          const listEl = document.getElementById('contact-picker-list');
          listEl.innerHTML = '';

          const chat = state.chats[state.activeChatId];
          const existingMemberIds = new Set(chat.members.map(m => m.id));
          existingMemberIds.add('user'); // 把用户自己也算作已存在成员

          // 和创建群聊时一样，整合所有角色和NPC
          const allAvailablePeople = [];
          Object.values(state.chats)
            .filter(c => !c.isGroup)
            .forEach(c => {
              allAvailablePeople.push({
                id: c.id,
                name: c.name,
                avatar: c.settings.aiAvatar || defaultAvatar,
                isNpc: false,
              }
function handleWaimaiResponse(originalTimestamp, choice) {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
          if (messageIndex === -1) return;

          // 1. 更新原始消息的状态
          const originalMessage = chat.history[messageIndex];
          originalMessage.status = choice;

          // 记录支付者，并构建对AI更清晰的系统消息
          let systemContent;
          const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';

          if (choice === 'paid') {
            originalMessage.paidBy = myNickname; // 记录是用户付的钱
            systemContent = `[系统提示：你 (${myNickname}
function handleInitiateCall() {
          if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;

          const chat = state.chats[state.activeChatId];
          videoCallState.isGroupCall = chat.isGroup;
          videoCallState.isAwaitingResponse = true;
          videoCallState.initiator = 'user';
          videoCallState.activeChatId = chat.id;
          videoCallState.isUserParticipating = true;

          // 1. 显示“正在呼叫”界面
          if (chat.isGroup) {
            document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
            document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || '我';
          }
function startVideoCall() {
          const chat = state.chats[videoCallState.activeChatId];
          if (!chat) return;

          // 提取通话前的最后20条消息作为上下文
          videoCallState.preCallContext = chat.history
            .slice(-20)
            .map(
              msg =>
                `${msg.role === 'user' ? chat.settings.myNickname || '我' : msg.senderName || chat.name}
function minimizeVideoCall() {
          // 访问内部变量 videoCallState
          if (!videoCallState.isActive) return;

          const chat = state.chats[videoCallState.activeChatId];
          const bubble = document.getElementById('video-call-floating-bubble');
          const avatarImg = document.getElementById('video-floating-avatar');

          // 1. 设置悬浮球头像
          if (chat) {
            const avatarUrl = chat.isGroup
              ? chat.settings.groupAvatar || defaultGroupAvatar
              : chat.settings.aiAvatar || defaultAvatar;
            avatarImg.src = avatarUrl;
          }
function updateParticipantAvatars() {
          const grid = document.getElementById('participant-avatars-grid');
          grid.innerHTML = '';
          const chat = state.chats[videoCallState.activeChatId];
          if (!chat) return;

          let participantsToRender = [];

          // 区分群聊和单聊
          if (videoCallState.isGroupCall) {
            // 群聊逻辑：显示所有已加入的AI成员
            participantsToRender = [...videoCallState.participants];
            // 如果用户也参与了，就把用户信息也加进去
            if (videoCallState.isUserParticipating) {
              participantsToRender.unshift({
                id: 'user',
                name: chat.settings.myNickname || '我',
                avatar: chat.settings.myAvatar || defaultMyGroupAvatar,
              }
function showIncomingCallModal(chatId) {
          // <--- 在括号里添加 chatId
          const chat = state.chats[chatId]; // <--- 把 state.activeChatId 修改为 chatId
          if (!chat) return;

          // 根据是否群聊显示不同信息
          if (chat.isGroup) {
            // 从 videoCallState 中获取是哪个成员发起的通话
            const requesterName = videoCallState.callRequester || chat.members[0]?.name || '一位成员';
            document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
            document.getElementById('caller-name').textContent = chat.name; // 显示群名
            document.querySelector(
              '.incoming-call-content .caller-text',
            ).textContent = `${requesterName}
function triggerAiInCallAction(userInput = null) {
          if (!videoCallState.isActive) return;

          const chat = state.chats[videoCallState.activeChatId];
          const { proxyUrl, apiKey, model }
function handleWaimaiResponse(originalTimestamp, choice) {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
          if (messageIndex === -1) return;

          // 1. 更新内存中原始消息的状态
          const originalMessage = chat.history[messageIndex];
          originalMessage.status = choice;

          // 2. 获取当前用户的昵称，并构建对AI更清晰的系统消息
          let systemContent;
          const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';

          if (choice === 'paid') {
            originalMessage.paidBy = myNickname; // 记录是“我”付的钱
            systemContent = `[系统提示：你 (${myNickname}
function handlePacketClick(timestamp) {
          const currentChatId = state.activeChatId;
          const freshChat = await db.chats.get(currentChatId);
          if (!freshChat) return;

          state.chats[currentChatId] = freshChat;
          const packet = freshChat.history.find(m => m.timestamp === timestamp);
          if (!packet) return;

          const myNickname = freshChat.settings.myNickname || '我';
          const hasClaimed = packet.claimedBy && packet.claimedBy[myNickname];

          // 如果是专属红包且不是给我的，或已领完，或已领过，都只显示详情
          if (
            (packet.packetType === 'direct' && packet.receiverName !== myNickname) ||
            packet.isFullyClaimed ||
            hasClaimed
          ) {
            showRedPacketDetails(packet);
          }
function handleOpenRedPacket(packet) {
          const chat = state.chats[state.activeChatId];
          const myNickname = chat.settings.myNickname || '我';

          // 1. 检查红包是否还能领
          const remainingCount = packet.count - Object.keys(packet.claimedBy || {}
function handleUserVote(timestamp, choice) {
          const chat = state.chats[state.activeChatId];
          const poll = chat.history.find(m => m.timestamp === timestamp);
          const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';

          // 1. 如果投票不存在或已关闭，直接返回
          if (!poll || poll.isClosed) {
            // 如果是已关闭的投票，则直接显示结果
            if (poll && poll.isClosed) {
              showPollResults(timestamp);
            }
function renderAiAvatarLibrary() {
          const grid = document.getElementById('ai-avatar-library-grid');
          grid.innerHTML = '';
          const chat = state.chats[state.activeChatId];
          const library = chat.settings.aiAvatarLibrary || [];

          if (library.length === 0) {
            grid.innerHTML =
              '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">这个头像库还是空的，点击右上角“添加”吧！</p>';
            return;
          }
function triggerGroupAiAction(chatId) {
          const chat = state.chats[chatId];
          if (!chat || !chat.isGroup) return;

          const { proxyUrl, apiKey, model }
function startGroupSimulation() {
          if (groupSimulationIntervalId) return; // 如果已经启动，则不重复启动

          // 我们设置一个相对较短的间隔（比如30秒）来作为“主时钟”的频率
          // 它不是具体某个群聊的活动间隔，而是检查所有群聊的频率

          // updated by lrq 251028
          // 加长检查间隔，防止已经触发自动回复但api未返回时重复触发导致多次回复。60秒间隔大于一般API返回数据时间的平均值，且不会过长影响使用体验。
          groupSimulationIntervalId = setInterval(runGroupSimulationTick, 60000); // 60秒检查一次
          console.log('群聊后台活动主时钟已启动，每60秒检查一次所有群聊。');
        }
function runGroupSimulationTick() {
          const allGroupChats = Object.values(state.chats).filter(chat => chat.isGroup);

          allGroupChats.forEach(chat => {
            const bgSettings = chat.settings.backgroundActivity;
            // 检查1：该群聊自己的开关是否开启
            if (bgSettings && bgSettings.enabled) {
              const now = Date.now();

              // 检查2：使用该群聊自己设置的间隔期
              const intervalMs = (bgSettings.interval || 120) * 1000;
              //const lastActivity = bgSettings.lastActivityTimestamp || 0;

              // updated by lrq 251028
              // 使用当前群聊最后一条消息时间作为最后活动时间
              const lastMessage = chat.history.slice(-1)[0];
              const lastActivity = lastMessage ? lastMessage.timestamp : 0;

              // 检查3：是否到达了该群聊的行动时间
              if (now - lastActivity > intervalMs) {
                console.log(`群聊 "${chat.name}
function renderIconSettings() {
          const grid = document.getElementById('icon-settings-grid');
          if (!grid) return;
          grid.innerHTML = '';

          const appLabels = {
            'world-book': '世界书',
            qq: 'QQ',
            'api-settings': 'API设置',
            wallpaper: '壁纸',
            font: '字体',
            'check-phone': '查手机',
            weibo: '微博',
            forum: '圈子',
            'lovers-space': '情侣空间',
            'game-hall': '游戏大厅',
            'x-social': 'X社交',
            taobao: '桃宝',
            'date-a-live': '约会大作战',
            'tukey-accounting': '兔兔记账',
            'kk-checkin': 'kk查岗',
            studio: 'lrq小剧场',
          }
function openCategoryManager() {
          await renderCategoryListInManager();
          document.getElementById('world-book-category-manager-modal').classList.add('visible');
        }
function openFrameSelectorModal(type, targetId = null) {
          const grid = document.getElementById('avatar-frame-grid');
          grid.innerHTML = '';

          currentFrameSelection.type = type;
          currentFrameSelection.target = targetId;

          const chat = state.chats[state.activeChatId];
          let currentFrameUrl = '';
          let previewAvatarUrl = '';

          if (type === 'char-weibo') {
            // 如果是为“角色微博”换框
            const charChat = state.chats[currentViewingWeiboProfileId];
            currentFrameUrl = charChat.settings.weiboAvatarFrame || '';
            previewAvatarUrl = charChat.settings.weiboAvatar || defaultAvatar;
          }
function renderApiPresetSelector() {
          const selectEl = document.getElementById('api-preset-select');
          if (!selectEl) return;

          selectEl.innerHTML = '<option value="">-- 自定义配置 --</option>';

          if (state.apiPresets) {
            state.apiPresets.forEach(preset => {
              const option = document.createElement('option');
              option.value = preset.id;
              option.textContent = preset.name;
              selectEl.appendChild(option);
            }
function handleApiPresetSelectChange() {
          const selectEl = document.getElementById('api-preset-select');
          const proxyUrlInput = document.getElementById('proxy-url');
          const apiKeyInput = document.getElementById('api-key');
          const selectedId = parseInt(selectEl.value);

          if (selectedId && state.apiPresets) {
            const selectedPreset = state.apiPresets.find(p => p.id === selectedId);
            if (selectedPreset) {
              proxyUrlInput.value = selectedPreset.proxyUrl;
              apiKeyInput.value = selectedPreset.apiKey;
            }
function openApiPresetManager() {
          const selectEl = document.getElementById('api-preset-select');
          const selectedId = parseInt(selectEl.value);
          const selectedPreset = state.apiPresets ? state.apiPresets.find(p => p.id === selectedId) : null;

          const modal = document.getElementById('preset-actions-modal');
          const footer = modal.querySelector('.custom-modal-footer');

          footer.innerHTML = `
			        <button id="preset-action-save-new">保存当前配置为新预设</button>
			        <button id="preset-action-update-current" ${!selectedPreset ? 'disabled' : ''}
function saveCurrentApiConfigAsPreset() {
          const proxyUrl = document.getElementById('proxy-url').value.trim();
          const apiKey = document.getElementById('api-key').value.trim();

          if (!proxyUrl || !apiKey) {
            alert('代理地址和密钥都不能为空！');
            return;
          }
function updateSelectedApiPreset(presetId) {
          const proxyUrl = document.getElementById('proxy-url').value.trim();
          const apiKey = document.getElementById('api-key').value.trim();

          if (!proxyUrl || !apiKey) {
            alert('代理地址和密钥都不能为空！');
            return;
          }
function deleteSelectedApiPreset(presetId) {
          const preset = state.apiPresets.find(p => p.id === presetId);
          if (preset) {
            const confirmed = await showCustomConfirm('确认删除', `确定要删除API预设 "${preset.name}
function initDraggableLyricsBar() {
          const bar = document.getElementById('floating-lyrics-bar');
          const phoneScreen = document.getElementById('phone-screen');

          let isDragging = false;
          let offsetX, offsetY;

          const onDragStart = e => {
            // 检查点击的是否是按钮，如果是，则不开始拖动
            if (e.target.closest('#lyrics-settings-btn') || e.target.closest('.close-btn')) {
              return;
            }
function applyLyricsSettings() {
          const bar = document.getElementById('floating-lyrics-bar');
          const toggleBtn = document.getElementById('toggle-lyrics-bar-btn');

          // 应用样式
          bar.style.fontSize = `${lyricsBarSettings.fontSize}
function generateCharacterPhoneData() {
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];
          if (!chat) return;

          showGenerationOverlay('正在同步Ta的手机数据...');

          try {
            const userNickname = state.qzoneSettings.nickname || '我';

            // 限制人设长度，这是防止503错误的根本方法！
            // 只取人设的前4000个字符，避免整个人设过长导致请求失败。
            const persona = (chat.settings.aiPersona || '').substring(0, 4000);

            const recentHistory = chat.history
              .slice(-chat.settings.maxMemory || 20)
              .map(msg => {
                const sender = msg.role === 'user' ? userNickname : chat.name;
                return `${sender}
function generateNewDiaryEntry() {
          const userNickname = state.qzoneSettings.nickname || '我';
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];
          if (!chat) return;

          document.getElementById('generation-overlay').classList.add('visible');

          try {
            const persona = chat.settings.aiPersona;
            const recentHistory = chat.history
              .slice(-chat.settings.maxMemory || 20)
              .map(msg => {
                const sender = msg.role === 'user' ? userNickname : chat.name;
                return `${sender}
function openChatSearchScreen() {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          // 清空旧的搜索条件和结果
          document.getElementById('keyword-search-input').value = '';
          document.getElementById('sender-search-select').innerHTML = '';
          document.getElementById('date-search-input').value = '';
          document.getElementById('chat-search-results-list').innerHTML =
            '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">输入条件开始搜索</p>';

          // 动态填充“人物”下拉菜单
          const senderSelect = document.getElementById('sender-search-select');
          senderSelect.innerHTML = '<option value="">所有人</option>'; // 默认选项

          const myNickname = chat.isGroup ? chat.settings.myNickname || '我' : '我';
          const myOption = document.createElement('option');
          myOption.value = myNickname;
          myOption.textContent = myNickname;
          senderSelect.appendChild(myOption);

          if (chat.isGroup) {
            chat.members.forEach(member => {
              const memberOption = document.createElement('option');
              memberOption.value = member.originalName; // 使用本名进行精确匹配
              memberOption.textContent = member.groupNickname; // 显示群昵称给用户看
              senderSelect.appendChild(memberOption);
            }
function renderCharStickers(type) {
          const isExclusive = type === 'exclusive';
          const gridId = isExclusive ? 'exclusive-sticker-grid' : 'common-sticker-grid';
          const grid = document.getElementById(gridId);
          grid.innerHTML = '';

          let stickers = [];
          if (isExclusive) {
            const chat = state.chats[state.activeChatId];
            stickers = chat.settings.stickerLibrary || [];
          }
function sendTarotReadingToChat() {
          if (!activeTarotReading || !state.activeChatId) return;

          const chat = state.chats[state.activeChatId];
          const { proxyUrl, apiKey, model }
function startPetDecayTimer() {
          stopPetDecayTimer(); // 先确保停止任何旧的计时器

          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.settings.pet || chat.settings.pet.type === '无') {
            return; // 如果当前聊天没有宠物，则不启动
          }
function renderChatPet() {
          const chat = state.chats[state.activeChatId];
          const petContainer = document.getElementById('chat-pet-container');
          const petEl = document.getElementById('chat-pet');

          if (
            !chat ||
            chat.isGroup ||
            !chat.settings.petAdopted ||
            !chat.settings.pet ||
            !chat.settings.pet.display.show
          ) {
            petEl.style.display = 'none';
            return;
          }
function handlePetInteraction(action) {
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.settings.petAdopted || !chat.settings.pet || chat.settings.pet.type === '无') {
            alert('你还没有宠物，或者还没有给它设定种类哦！');
            return;
          }
function openPetChat() {
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.settings.pet || chat.settings.pet.type === '无') {
            alert('先给你的宠物起个名字和种类吧！');
            return;
          }
function renderPetChatHistory() {
          const chat = state.chats[state.activeChatId];
          const pet = chat.settings.pet;
          const messagesEl = document.getElementById('pet-chat-messages');
          messagesEl.innerHTML = '';

          if (!pet.petChatHistory || pet.petChatHistory.length === 0) {
            messagesEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">试着和它打个招呼吧！</p>`;
            return;
          }
function handleSendToPet() {
          const chat = state.chats[state.activeChatId];
          const pet = chat.settings.pet;
          const input = document.getElementById('pet-chat-input');
          const userInput = input.value.trim();
          if (!userInput) return;

          input.value = '';
          input.style.height = 'auto';

          pet.petChatHistory.push({ sender: 'user', content: userInput }
function getPetApiResponse(pet) {
          const { proxyUrl, apiKey, model }
function checkAndTriggerSummary(chatId) {
          if (isSummarizing) return;

          const chat = state.chats[chatId];
          if (!chat || !chat.settings.summary || !chat.settings.summary.enabled) return;

          const summarySettings = chat.settings.summary;
          // 不再从0开始，而是从上次总结的位置开始计算
          const lastSummaryIndex = summarySettings.lastSummaryIndex;
          const messagesSinceLastSummary = chat.history.slice(lastSummaryIndex + 1);

          if (messagesSinceLastSummary.length >= summarySettings.count) {
            isSummarizing = true;
            if (summarySettings.mode === 'auto') {
              await performAutomaticSummary(chatId);
            }
function generateSummary(chatId, specificMessages = null) {
          const chat = state.chats[chatId];
          const { proxyUrl, apiKey, model }
function generateConciseSummary(originalText) {
          const { proxyUrl, apiKey, model }
function getTokenDetailedBreakdown(chatId) {
          const chat = state.chats[chatId];
          if (!chat) return null;

          const settings = chat.settings;
          const breakdown = [];
          const outlierThreshold = 300; // 设定阈值：超过300字符被视为"大消息"
          let outliers = []; // 用于存储异常大的消息

          // ... (前1-4部分保持不变: 人设、世界书、表情包、总结) ...
          // 1. 核心人设
          let personaText = chat.isGroup
            ? `群聊...${chat.members.map(m => m.persona).join('')}
function getContextForTokenCalculation(chatId) {
          const chat = state.chats[chatId];
          if (!chat) return '';

          let combinedText = '';
          const settings = chat.settings;

          // 1. 添加核心提示词 (人设)
          if (chat.isGroup) {
            const membersList = chat.members.map(m => `- **${m.originalName}
function updateStreak(chatId) {
          const chat = state.chats[chatId];
          // 如果不是单聊，或者功能未开启，直接返回
          if (!chat || chat.isGroup || !chat.settings.streak?.enabled) {
            return false;
          }
function handleSetMemberTitle(memberId) {
          const chat = state.chats[state.activeChatId];
          // 权限检查：群主或管理员才能设置
          const isOwner = chat.ownerId === 'user';
          const isAdmin = chat.settings.isUserAdmin;

          if (!chat || (!isOwner && !isAdmin)) {
            alert('你不是群主或管理员，没有权限执行此操作！');
            return;
          }
function handleTransferOwnership(memberId) {
          const chat = state.chats[state.activeChatId];
          const newOwner = chat.members.find(m => m.id === memberId);
          if (!newOwner) return;

          // 获取旧群主的昵称，也就是你自己的昵称
          const oldOwnerNickname = chat.settings.myNickname || '我';

          const confirmed = await showCustomConfirm(
            '转让群主',
            `你确定要将群主身份转让给“${newOwner.groupNickname}
function openGroupAnnouncementModal() {
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.isGroup) return;

          const modal = document.getElementById('group-announcement-modal');
          const contentArea = document.getElementById('announcement-content-area');
          const footer = document.getElementById('announcement-footer');

          const announcement = chat.settings.groupAnnouncement || '暂无公告';
          contentArea.innerHTML = announcement.replace(/\n/g, '<br>');

          const canEdit = chat.ownerId === 'user' || chat.settings.isUserAdmin;

          footer.innerHTML = '';
          if (canEdit) {
            const editBtn = document.createElement('button');
            editBtn.className = 'cancel';
            editBtn.textContent = '编辑';
            // 改用 addEventListener 来绑定事件，更安全可靠
            editBtn.addEventListener('click', editGroupAnnouncement);
            footer.appendChild(editBtn);
          }
function editGroupAnnouncement() {
          const chat = state.chats[state.activeChatId];
          const contentArea = document.getElementById('announcement-content-area');
          const footer = document.getElementById('announcement-footer');

          const currentContent = chat.settings.groupAnnouncement || '';
          contentArea.innerHTML = `<textarea id="announcement-editor">${currentContent}
function saveGroupAnnouncement() {
          const chat = state.chats[state.activeChatId];
          const newContent = document.getElementById('announcement-editor').value.trim();

          chat.settings.groupAnnouncement = newContent;
          await db.chats.put(chat);

          const myNickname = chat.settings.myNickname || '我';
          await logSystemMessage(chat.id, `“${myNickname}
function getStreakContext(chat) {
          // 1. 安全检查：如果不是单聊，或者功能未开启，则直接返回空内容
          if (!chat || chat.isGroup || !chat.settings.streak?.enabled) {
            return '';
          }
function showInnerVoiceEditOptions() {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const borderHidden = chat.settings.innerVoiceHideHeaderBorder || false;
          const borderOptionText = borderHidden ? '显示分割线' : '隐藏分割线';

          // 选项数组里新增 'editStyles'
          const choice = await showChoiceModal('编辑心声面板', [
            { text: '🎨 编辑面板样式', value: 'editStyles' }
function toggleInnerVoiceHeaderBorder() {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          // 确保 chat.settings 存在
          if (!chat.settings) chat.settings = {}
function editInnerVoiceAdopterName() {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          // 获取当前的标签模板，如果没有设置过，就使用默认值
          const currentFormat = chat.settings.innerVoiceAdopterLabelFormat || '领养人: {{user}
function applySavedInnerVoiceStyles() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.settings.innerVoiceStyles) return;

          const styles = chat.settings.innerVoiceStyles;
          const panel = document.getElementById('inner-voice-main-panel');

          panel.style.setProperty('--iv-color-clothing', styles.clothingColor);
          panel.style.setProperty('--iv-color-behavior', styles.behaviorColor);
          panel.style.setProperty('--iv-color-thoughts', styles.thoughtsColor);
          panel.style.setProperty('--iv-color-naughty', styles.naughtyColor);
          panel.style.setProperty('--iv-card-bg-rgb', hexToRgb(styles.cardBgColor));
          panel.style.setProperty('--iv-card-opacity', styles.cardOpacity);

          // 应用保存的图标颜色
          panel.style.setProperty('--iv-icon-color', styles.iconColor || '#ff8a80');
        }
function openInnerVoiceStyleEditor() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.settings.innerVoiceStyles) return;

          document.getElementById('inner-voice-edit-options-modal')?.classList.remove('visible');

          const styles = chat.settings.innerVoiceStyles;
          const modal = document.getElementById('inner-voice-editor-modal');

          // 加载当前样式到编辑器
          document.getElementById('iv-color-clothing').value = styles.clothingColor;
          document.getElementById('iv-color-behavior').value = styles.behaviorColor;
          document.getElementById('iv-color-thoughts').value = styles.thoughtsColor;
          document.getElementById('iv-color-naughty').value = styles.naughtyColor;
          document.getElementById('iv-card-bg-color').value = styles.cardBgColor;
          document.getElementById('iv-opacity-slider').value = styles.cardOpacity;
          document.getElementById('iv-opacity-value').textContent = `${Math.round(styles.cardOpacity * 100)}
function exportDataStream() {
          await showCustomAlert('请稍候...', '正在准备流式导出，这可能需要一些时间，但不会使浏览器崩溃。');

          // 定义所有需要备份的数据库表名
          const tablesToExport = [
            'chats',
            'apiConfig',
            'globalSettings',
            'userStickers',
            'charStickers',
            'worldBooks',
            'musicLibrary',
            'personaPresets',
            'qzoneSettings',
            'qzonePosts',
            'qzoneAlbums',
            'qzonePhotos',
            'favorites',
            'qzoneGroups',
            'memories',
            'worldBookCategories',
            'callRecords',
            'customAvatarFrames',
            'themes',
            'apiPresets',
            'bubbleStylePresets',
            'fontPresets',
            'homeScreenPresets',
            'weiboPosts',
            'forumGroups',
            'forumPosts',
            'forumComments',
            'forumCategories',
            'tarotReadings',
            'pomodoroSessions',
            'scriptKillScripts',
            'taobaoProducts',
            'taobaoOrders',
            'taobaoCart',
            'userWalletTransactions',
            'userStickerCategories',
            'datingScenes',
            'datingPresets',
            'datingSpriteGroups',
            'datingSprites',
            'datingHistory',
          ];

          const stream = new ReadableStream({
            async start(controller) {
              const encoder = new TextEncoder();

              // 1. 写入JSON文件的开头
              controller.enqueue(encoder.encode('{\n'));

              // 2. 添加版本和时间戳元数据
              const metaData = `"version": 1,\n"timestamp": ${Date.now()}
function calculateIntimacy(chat) {
          if (!chat || !chat.settings.streak) return 0;

          // 基础分：火花天数，每天都很重要！
          const streakDays = chat.settings.streak.currentDays || 0;
          const streakScore = streakDays * 15; // 每天火花提供15点基础分

          // 互动分：累计消息总数
          const stats = chat.interactionStats || {}
function selectIntimacyBadge(chatId, symbol) {
          const chat = state.chats[chatId];
          if (!chat) return;

          // 更新选择
          chat.settings.selectedIntimacyBadge = symbol;

          // 保存到数据库
          await db.chats.put(chat);

          // 重新渲染面板，更新高亮状态
          await openIntimacyPanel(chatId);

          // 重新渲染聊天列表，让徽章立刻显示出来
          await renderChatList();
        }
function toggleWorldBookEditMode() {
          isWorldBookEditMode = !isWorldBookEditMode;

          const screen = document.getElementById('world-book-screen');
          const listEl = document.getElementById('world-book-list');
          const editBtn = document.getElementById('toggle-world-book-edit-mode-btn');
          const manageBtn = document.getElementById('manage-categories-in-edit-mode-btn');
          const addBtn = document.getElementById('add-world-book-btn');
          const importBtn = document.getElementById('import-world-book-btn');

          const deleteBtn = document.getElementById('world-book-delete-selected-btn');

          screen.classList.toggle('selection-mode', isWorldBookEditMode);
          listEl.classList.toggle('selection-mode', isWorldBookEditMode);

          if (isWorldBookEditMode) {
            editBtn.textContent = '完成';
            manageBtn.style.display = 'inline-block';
            deleteBtn.style.display = 'inline-flex'; // 让删除按钮显示
            addBtn.style.display = 'none';
            importBtn.style.display = 'none';
          }
function handleWorldBookListClick(e) {
          const item = e.target.closest('.list-item');
          if (!item) return;

          const bookId = item.dataset.bookId;
          if (!bookId) return;

          if (isWorldBookEditMode) {
            // 编辑模式：处理选择/取消选择
            item.classList.toggle('selected');
            if (selectedWorldBooks.has(bookId)) {
              selectedWorldBooks.delete(bookId);
            }
function updateWorldBookDeleteButton() {
          const deleteBtn = document.getElementById('world-book-delete-selected-btn');
          const countSpan = document.getElementById('world-book-delete-count');
          const count = selectedWorldBooks.size;

          // 更新按钮旁边的数字
          if (count > 0) {
            countSpan.textContent = `(${count}
function createWorldBookGroup(groupName, books) {
          const groupContainer = document.createElement('div');
          groupContainer.className = 'world-book-group-container';

          groupContainer.innerHTML = `
			        <div class="world-book-group-header">
			            <span class="arrow">▼</span>
			            <span class="group-name">${groupName}
function openAuroraBookshelf() {
          // 关闭设置弹窗
          document.getElementById('aurora-setup-modal').classList.remove('visible');
          // 渲染书架
          await renderBookshelf();
          // 显示书架屏幕
          showScreen('aurora-bookshelf-screen');
        }
function renderBookshelf() {
          const container = document.getElementById('bookshelf-container');
          container.innerHTML = '';

          // 从数据库获取所有书籍，按添加时间倒序
          const books = await db.auroraBooks.orderBy('addedAt').reverse().toArray();

          if (books.length === 0) {
            container.innerHTML =
              '<div class="bookshelf-row" style="justify-content:center; align-items:center; color:#8d6e63; font-size:14px;">书架空空如也...</div>';
            return;
          }
function loadBookFromShelf(book) {
          // 更新全局状态
          auroraState = {
            active: true,
            mode: 'text',
            title: book.title,
            subtitles: [],
            textContent: book.content,
            lastSyncTime: 0,
            // ★★★ 新增：记录当前正在读哪本书的ID，以便保存进度
            currentBookId: book.id,
          }
function init() {
          const savedTheme = localStorage.getItem('ephone-theme') || 'light'; // 默认为日间模式
          applyTheme(savedTheme);

          const customBubbleStyleTag = document.createElement('style');
          customBubbleStyleTag.id = 'custom-bubble-style';
          document.head.appendChild(customBubbleStyleTag);

          const previewBubbleStyleTag = document.createElement('style');
          previewBubbleStyleTag.id = 'preview-bubble-style';
          document.head.appendChild(previewBubbleStyleTag);

          applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // 清除真实聊天界面的自定义样式
          applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // 清除预览区的自定义样式

          window.showScreen = showScreen;
          window.openLoversSpaceFromCard = openLoversSpaceFromCard;
          window.renderChatListProxy = renderChatList;
          window.renderApiSettingsProxy = renderApiSettings;
          window.renderWallpaperScreenProxy = renderWallpaperScreen;
          window.renderWorldBookScreenProxy = renderWorldBookScreen;

          await loadAllDataFromDB();
          // 添加启动时加载CSS的逻辑
          // 优先应用保存在 activeCustomCss 里的代码
          if (state.globalSettings.activeCustomCss) {
            applyThemeCss(state.globalSettings.activeCustomCss);
          }
function renderGroupMemberSettings(members) {
            const container = document.getElementById('group-members-settings');
            container.innerHTML = '';
            members.forEach(member => {
              const div = document.createElement('div');
              div.className = 'member-editor';
              div.dataset.memberId = member.id;

              // 显示的是 groupNickname
              div.innerHTML = `<img src="${member.avatar}
</script>
</body>
</html>